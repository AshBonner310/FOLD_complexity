---
title: "Regime Shift Scenarios"
author: "Ashley Bonner"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, echo=FALSE}

library(tidyverse) #data library
library(deSolve) #ODE solver
library(patchwork) #figure arrangement
library(dplyr) #data wrangling
library(ggplot2)

knitr::opts_chunk$set(echo = TRUE)

```


# Scenario Goals
We are looking to compare a one-pool model with a single decay rate against a multi-pool model with transfer of soil carbon between pools in simulated real-world scenarios.
This Markdown is going to test how a one-pool model fares against a multipool soil carbon model to a vegetation regime shift

First, setting up our models for testing.

```{r setup}
#functions
source("R/AggregateDecayRate.R")
source("R/OnePool_ODE.R")
source("R/FivePool_ODE.R")
source("R/FivePool_SS.R")

#parameters
##five pool
temp <- read_csv(file.path("Data/FivePoolModel_Parameters.csv"), show_col_types = FALSE)
Params_FivePool.ls <- list()

for(i in 1:ncol(temp)) {
  Params_FivePool.ls[[i]] <- as.numeric(temp[,i])
}
names(Params_FivePool.ls) <- colnames(temp)

#create the One-pool parameters with aggregate decay rate.
Params_Aggregate.ls <- list(ave_inputs = Params_FivePool.ls$ave_inputs, #g-C m-2 yr-1, according to CENTURY model validation
                            turnoverTime = Proxy_decayrate.fn(parms = Params_FivePool.ls)
                            )

```



# Regime Shift - input levels

Modeling soil carbon in earth systems (such as forecasting carbon totals for climate change) want to capture how soil carbon stocks respond to natural and unnatural dynamics and fluctuations.
In temperate systems, a seasonal fluctuation in Vegetation Biomass' Net Primary Productivity is well established.
As carbon inputs to soil are assumed to follow NPP fluctuations, we want to assess how our one pool model responds to these fluctuations, to determine if a one pool model can suffice in global earth system models.
We'll use a weekly simulation over five years to determine fit.


```{r InputsForIncub}
##define a function where inputs shift after a year
NPPshift.fn <- function(time, parms){
  
  if(time == 0){
    u <- parms$ave_inputs
  }else{
    u <- parms$ave_inputs*parms$NPPshift
  }
  
  return(u)
}

# #Simulation Times vector
SimTimes <- c(seq(0, 50, by = 1/12), # first ten years, by month
              seq(1, 10, by = 1), # up to ten years, by year
              seq(10, 1e3, by = 10), # up to thousand years, by decade
              seq(1e3, 2e4, by = 100) # up to twenty thousand years, by century
              ) %>%
  unique()
  

Inputs_sim <- as.data.frame(SimTimes)

NPP_shifts <- seq(0, 2, by = 0.20) #c(0, 0.25, 0.5, 0.75, 0.9, 0.95, 1, 1.05, 1.1, 1.25, 1.5, 1.75, 2)

for(i in 1:length(NPP_shifts)){

Params_Aggregate.ls$NPPshift <- NPP_shifts[i] 

temp <- as.data.frame(SimTimes) %>%
  mutate(inputs = NPPshift.fn(time = SimTimes, parms = Params_Aggregate.ls), 
         .by=SimTimes) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )

Inputs_sim <- full_join(Inputs_sim, temp)
}

ggplot(Inputs_sim) +
  geom_line(aes(x = SimTimes, y=inputs, color=inputs_shift)) +
  labs(title = "Inputs over Simulation period", x = "Time (years)", y = "Soil Carbon Inputs (gC per m2 per year)")
```


```{r Simulations}
###AGGREGATE DECAY RATE ONE POOL SIMULATIONS
##add needed input function to parameter lists
Params_Aggregate.ls$inputs.fn <- NPPshift.fn

#creating an empty data frame to populate through for loop
NPPshift_Sim1.df <- data.frame(time=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_Aggregate.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))),
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Input_Rate = Params_Aggregate.ls$inputs.fn(t = time,
                                                  parms = Params_Aggregate.ls),
         .by = everything()) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
 NPPshift_Sim1.df <- full_join(NPPshift_Sim1.df, 
                               temp, 
                               by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))

}

# ##Graph both shifts with the one pool model
# ggplot(NPPshift_Sim1.df %>%
#          select(time, Respiration_Rate, Input_Rate, inputs_shift) %>% 
#          pivot_longer(cols = Respiration_Rate:Input_Rate,
#                                names_to = "Rate",
#                                values_to = "Value")) + 
#   geom_line(aes(x=time, y=Value, color=inputs_shift)) + 
#   facet_wrap(~ Rate, ncol=1, scales='free') + 
#   labs(title = "Regime Shifts: One Pool", x = "Time (years)", y = "Carbon per hour (gC per m2)")
# 
# ggplot(NPPshift_Sim1.df %>%
#          select(time, Soil_Carbon_Concentration, inputs_shift)) + 
#   geom_line(aes(x=time, y=Soil_Carbon_Concentration, color=inputs_shift)) + 
#   labs(title = "Regime Shifts: One Pool", x = "Time (years)", y = "Soil Carbon Concentration (gC per m2)")

####FIVE POOL SIMULATIONS
##Add needed function to parameter list for Five Pool simulations
Params_FivePool.ls$inputs.fn <- NPPshift.fn


#creating an empty data frame to populate through for loop
NPPshift_Sim5.df <- data.frame(time=as.numeric(),
                               Metabolic_Plant_Residue=as.numeric(),
                               Structural_Plant_Residue=as.numeric(),
                               Fast_Soil=as.numeric(),
                               Slow_Soil=as.numeric(),
                               Passive_Soil=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_FivePool.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)),
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Input_Rate = Params_FivePool.ls$inputs.fn(t = time,
                                                  parms = Params_FivePool.ls),
         .by = everything()
  ) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
  NPPshift_Sim5.df <- full_join(NPPshift_Sim5.df, 
                               temp,
                               by = join_by(time, Metabolic_Plant_Residue, Structural_Plant_Residue, Fast_Soil, Slow_Soil, Passive_Soil, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))
 
}



Initial_Sim_Runs.df <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool"),
                  by = join_by(time, Soil_Carbon_Concentration, inputs_shift, model)) %>%
  mutate(Soil_Carbon_Concentration = Soil_Carbon_Concentration/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>% 
  mutate("Shift in NPP" = as.numeric(inputs_shift))

```

```{r first plot}
### Cannot have a dashed line type (e.g., difference line types based on model)
# ggplot(Initial_Sim_Runs.df) + 
#   geom_line(data = Initial_Sim_Runs.df,
#              aes(x=time, 
#                 y=Soil_Carbon_Concentration,
#                 color = `Shift in NPP`, #inputs_shift,
#                 group = `Shift in NPP`,
#             linetype = model),
#             linewidth = 0.25) 


#Create a column to refer manual linetype for legend
modelsim <- c("One Pool" = "dashed",
          "Five Pool" = "solid")

temp.graph <- ggplot(Initial_Sim_Runs.df) + 
  geom_line(data = Initial_Sim_Runs.df %>% filter(model == "One Pool"),
             aes(x=time, 
                y=Soil_Carbon_Concentration,
                color = `Shift in NPP`, #inputs_shift,
                group = `Shift in NPP`,
                linetype = "dashed"),
            linewidth = 0.5,
            show.legend = TRUE) + 
  geom_line(data = Initial_Sim_Runs.df %>% filter(model == "Five Pool"),
             aes(x=time, 
                y=Soil_Carbon_Concentration,
                color = `Shift in NPP`, #inputs_shift,
                group = `Shift in NPP`,
            linetype = "solid"),
            linewidth = 0.5) + 
  scale_x_log10() +
  labs(linetype = "Model") +
  scale_linetype_manual(
    values = c("dashed", "solid"),
    labels = c("One Pool", "Five Pool")
  ) +
  scale_color_gradientn(colors=wes_palette(n=11, name="Zissou1Continuous"))
  #scale_color_gradientn(colours = rainbow(5))

Initial_Sim.graph <- temp.graph + 
  labs(title = "Regime Shift Forward Run",
       x = "Time (years)",
       y = "Ratio of SOC to initial value"
       ) +
  theme(text = element_text(size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6),
        legend.justification = "center")

Initial_Sim.graph


```


```{r}
# ggplot(Initial_Sim_Runs.df) + 
#   geom_line(aes(x=time, 
#                 y=Soil_Carbon_Concentration,
#                 color=inputs_shift, 
#                 linetype = model)) + 
#   labs(title = "Regime Shift",
#        y = "Ratio of SOC to initial value",
#        x = "Time (years)")

Difference.df <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  pivot_wider(names_from = model,
              values_from = Soil_Carbon_Concentration) %>%
  mutate(Difference = `Five Pool` - `One Pool`) 


###### Difference graph but no log-scale
# ggplot(Difference.df%>%
#   mutate(Difference = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))) +
#   geom_line(aes(x=time, y=Difference, color = inputs_shift))

temp.graph <- ggplot(Difference.df%>%
  mutate(Difference = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))) +
  geom_line(aes(x=time, 
                y=Difference, 
                color = as.numeric(inputs_shift),
                group = as.numeric(inputs_shift)
                )) + 
  scale_x_log10() +
  scale_color_gradientn(colors=wes_palette(n=11, name="Zissou1Continuous"))
  #scale_color_gradientn(colours = rainbow(5))

Difference.graph <- temp.graph + 
  labs(color = "Shift in NPP",
       title = "Difference in SOC simulation",
       x = "Time (years)",
       y = "Ratio of SOC to initial value") +
  theme(text = element_text(size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6),
        legend.justification = "center")

Difference.graph

# temp <- NPPshift_Sim5.df%>% 
#          select(time, Metabolic_Plant_Residue, Structural_Plant_Residue, Fast_Soil, Slow_Soil, Passive_Soil, inputs_shift) %>%
#          pivot_longer(cols = Metabolic_Plant_Residue:Passive_Soil,
#                                   names_to = 'Pool',
#                                   values_to = 'Mass')
# 
# temp$Pool <- factor(temp$Pool, levels = c("Metabolic_Plant_Residue", "Structural_Plant_Residue", "Fast_Soil", "Slow_Soil", "Passive_Soil"))
# 
# ggplot(temp) + 
#   geom_line(aes(x=time, y=Mass, color = inputs_shift)) + 
#   facet_wrap(~ Pool, ncol=1, scales='free') 
# 
# ggplot(temp) +
#   geom_area(aes(x=time, y=Mass, fill = Pool)) +
#   scale_fill_brewer(palette = "Spectral") +
#   facet_wrap(~ inputs_shift, ncol=1, scales='free') 
# 
# 
# ggplot(temp) +
#   geom_area(aes(x=time, y=Mass, fill = Pool)) +
#   scale_fill_brewer(palette = "Spectral") +
#   facet_wrap(~ inputs_shift, ncol=1, scales='free') 
# 
# 
# temp <- temp %>%
#   filter(inputs_shift == 0)
# 
# 
# ggplot(temp) +
#   geom_area(aes(x=time, y=Mass, fill = Pool)) +
#   scale_fill_brewer(palette = "Spectral") +
#   scale_x_log10()
# 
# ggplot(temp) +
#   geom_area(aes(x=time, y=Mass, fill = Pool)) +
#   scale_fill_brewer(palette = "Spectral") 
# 
# ggplot(temp %>% 
#          filter(time <= 100)) +
#   geom_area(aes(x=time, y=Mass, fill = Pool)) +
#   scale_fill_brewer(palette = "Spectral") 

```

```{r Paper Figure}

Initial_Sim.graph / Difference.graph + 
  plot_layout(guides = 'collect',
              axes = 'collect') 

ggsave("Figures/RegimeShift_SOC_Forward_Runs.pdf",
        device = pdf, 
       width = 17.8,
       height = 8,
       units = "cm")

```



```{r eval = FALSE, Difference Analysis }
  
###DEV NOTE:: ALL of this was done in previous chunks, commenting now in case there's something else here I want, but likely not.
# temp <- Difference.df %>%
#   mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
#   mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
#   mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
#   mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 1e-2)) %>%
#          mutate("Shift in NPP" = as.numeric(inputs_shift))
#   
# 
# # ggplot(temp) +
# #   geom_line(aes(x=time, y=`Normalized Difference to OG steady state`, color=inputs_shift))
# 
# Forward_Run_Difference.graph <- ggplot(temp) +
#   geom_line(aes(x=time, 
#                 y=`Normalized Difference to OG steady state`, 
#                 color= inputs_shift),
#             linewidth = 0.4) + 
#   scale_x_log10() + 
#   theme_bw() + 
#   labs(y = "Difference (% of Original State)",
#        x = "Time (years)",
#       color = "Shift in NPP") +
#   guides(color = guide_legend(override.aes = list(linewidth = 1))) +
#   theme(text = element_text(size = 9),
#         axis.title.y = element_text(size = 8),
#         legend.title = element_text(size = 6),
#         legend.text = element_text(size = 6),
#         legend.justification = "center", 
#         legend.key.size = unit(0.2, "lines"))
# 
# 
# 
# Temp_Initial_Sim.graph <- temp.graph + 
#   labs(y = "Ratio of SOC to initial value",
#        x = "Time (years)") +
#   theme(text = element_text(size = 9),
#         axis.title.y = element_text(size = 8),
#         legend.title = element_text(size = 6),
#         legend.text = element_text(size = 6),
#         legend.justification = "center", 
#         legend.key.size = unit(0.3, "lines"))
# 
# 
# 
# Temp_Initial_Sim.graph  / Forward_Run_Difference.graph +   
#   plot_layout(axes = "collect", 
#               guides = 'collect')
# 
# 
# ggsave("Figures/RegimeShift_SOC_Forward_Runs_Difference.pdf",
#        device = pdf, 
#        width = 17.8,
#        height = 9,
#        units = "cm")




# ggplot(temp %>% filter(inputs_shift != "0")) +
#   geom_line(aes(x=time, y=`Normalized Difference to Five Pool model`, color=inputs_shift))
# 
# ggplot(temp %>% filter(inputs_shift != "0")) +
#   geom_line(aes(x=time, y=`Normalized Difference to Five Pool model`, color=inputs_shift)) + 
#   ylim(-0.35,0.35) +
#   scale_x_log10()




Full_Run_Comp.graph <- ggplot(temp %>% 
         filter(Close == "TRUE")
         ) + 
  geom_point(aes(x=time, y=`Shift in NPP`, color = inputs_shift)) + xlim(0, 1e4)



# temp_graph <- ggplot(temp %>% 
#          filter(time <=20) %>%
#          filter(Close == "TRUE") %>%
#          mutate("NPP Shift" = as.numeric(inputs_shift))) + 
#   geom_point(aes(x=time, y=`NPP Shift`, color = inputs_shift), size = 1) +
#   labs(title = "",
#        x = "Time (years)",
#        y = "Relative Shift in NPP",
#        color = "Shift") + 
#     theme_bw()+
#   theme(text = element_text(size = 9),
#         axis.title.y = element_text(size = 8),
#         legend.title = element_text(size = 6),
#         legend.text = element_text(size = 6),
#         legend.justification = "center")

Full_Run_Comp.graph +
  labs(title = "",
       x = "Time (years)",
       y = "Relative Shift in NPP",
       color = "Shift") + 
    theme_bw()+
  theme(text = element_text(size = 9),
        axis.title.y = element_text(size = 8),
        legend.title = element_text(size = 6),
        legend.text = element_text(size = 6),
        legend.justification = "center")

ggsave("Figures/RS_SOC_Difference_Full.pdf",
       plot = temp_graph,
        device = pdf, 
       width = 8.7,
       height = 5,
       units = "cm")


# ggplot(temp %>% filter(time <= 5)) +
#   geom_line(aes(x=time, y=`Normalized Difference to Five Pool model`, color=inputs_shift))



```


```{r Simulations-short_time}
###AGGREGATE DECAY RATE ONE POOL SIMULATIONS

NPP_shifts <- seq(0.1, 2, by = 0.05)
SimTimes <- seq(0, 50, by = 1/12)


#creating an empty data frame to populate through for loop
NPPshift_Sim1.df <- data.frame(time=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_Aggregate.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))),
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Input_Rate = Params_Aggregate.ls$inputs.fn(t = time,
                                                  parms = Params_Aggregate.ls),
         .by = everything()) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
 NPPshift_Sim1.df <- full_join(NPPshift_Sim1.df, 
                               temp, 
                               by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))

}


####FIVE POOL SIMULATIONS
##Add needed function to parameter list for Five Pool simulations

#creating an empty data frame to populate through for loop
NPPshift_Sim5.df <- data.frame(time=as.numeric(),
                               Metabolic_Plant_Residue=as.numeric(),
                               Structural_Plant_Residue=as.numeric(),
                               Fast_Soil=as.numeric(),
                               Slow_Soil=as.numeric(),
                               Passive_Soil=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_FivePool.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)),
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Input_Rate = Params_FivePool.ls$inputs.fn(t = time,
                                                  parms = Params_FivePool.ls),
         .by = everything()
  ) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
  NPPshift_Sim5.df <- full_join(NPPshift_Sim5.df, 
                               temp,
                               by = join_by(time, Metabolic_Plant_Residue, Structural_Plant_Residue, Fast_Soil, Slow_Soil, Passive_Soil, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))
 
}


temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  mutate(Soil_Carbon_Concentration = Soil_Carbon_Concentration/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))


ggplot(temp) + 
  geom_line(aes(x=time, 
                y=Soil_Carbon_Concentration,
                color=inputs_shift, 
                linetype = model)) + 
  scale_x_log10() + 
  labs(title = "Regime Shift: Log10 scaled time",
       y = "Ratio of SOC to initial value",
       x = "Time (years), log10-scaled")

ggplot(temp) + 
  geom_line(aes(x=time, 
                y=Soil_Carbon_Concentration,
                color=inputs_shift, 
                linetype = model)) + 
  labs(title = "Regime Shift: Log10 scaled time",
       y = "Ratio of SOC to initial value",
       x = "Time (years)")

Difference.df <-  temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  pivot_wider(names_from = model,
              values_from = Soil_Carbon_Concentration) %>%
  mutate(Difference = `Five Pool` - `One Pool`) 


ggplot(Difference.df%>%
  mutate(Difference = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))) +
  geom_line(aes(x=time, y=Difference, color = inputs_shift))

ggplot(Difference.df%>%
  mutate(Difference = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))) +
  geom_line(aes(x=time, y=Difference, color = inputs_shift)) + scale_x_log10()



###Graphs for within 1% of each other

temp1 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 1e-2))%>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))

temp.01 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 1e-3))%>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))

temp5 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 5e-2)) %>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))


temp_graph <- ggplot(temp1) + 
  geom_point(aes(y=time, x=`NPP Shift`, color = inputs_shift), size = 1, shape = 15) +
  geom_point(data = temp5, aes(y=time, x=`NPP Shift`, color = inputs_shift), size = 0.5, shape = 1, alpha = 0.1) +
  geom_point(data = temp.01, aes(y=time, x=`NPP Shift`), size = 1, shape = 4) +
  labs(title = "Length of Simulation where Models agree",
       subtitle = "One-pool within 5%, 1%, and 0.1% of the five-pool",
       y = "Time (years)",
       x = "Relative Shift in NPP (%)",
       color = "Shift") + 
    theme_bw()+
  theme(text = element_text(size = 9),
        axis.title.y = element_text(size = 8),
        plot.title = element_text(size = 10),
        plot.subtitle = element_text(size = 7),
        legend.title = element_text(size = 6),
        legend.position = "none") 

# ggsave("Figures/RS_SOC_Difference.pdf",
#        plot = temp_graph,
#         device = pdf, 
#        width = 8.7,
#        height = 7,
#        units = "cm")

temp_graph

```

```{r Even More Granularity}
###AGGREGATE DECAY RATE ONE POOL SIMULATIONS

NPP_shifts <- seq(0.75, 1.25, by = 0.001)
SimTimes <- seq(0, 100, by = 1/12)


#creating an empty data frame to populate through for loop
NPPshift_Sim1.df <- data.frame(time=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_Aggregate.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))),
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Input_Rate = Params_Aggregate.ls$inputs.fn(t = time,
                                                  parms = Params_Aggregate.ls),
         .by = everything()) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
 NPPshift_Sim1.df <- full_join(NPPshift_Sim1.df, 
                               temp, 
                               by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))

}


####FIVE POOL SIMULATIONS
##Add needed function to parameter list for Five Pool simulations

#creating an empty data frame to populate through for loop
NPPshift_Sim5.df <- data.frame(time=as.numeric(),
                               Metabolic_Plant_Residue=as.numeric(),
                               Structural_Plant_Residue=as.numeric(),
                               Fast_Soil=as.numeric(),
                               Slow_Soil=as.numeric(),
                               Passive_Soil=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in 1:length(NPP_shifts)){

Params_FivePool.ls$NPPshift <- NPP_shifts[i] 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)),
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Input_Rate = Params_FivePool.ls$inputs.fn(t = time,
                                                  parms = Params_FivePool.ls),
         .by = everything()
  ) %>%
  mutate(inputs_shift = as.character(NPP_shifts[i]) )
 
  NPPshift_Sim5.df <- full_join(NPPshift_Sim5.df, 
                               temp,
                               by = join_by(time, Metabolic_Plant_Residue, Structural_Plant_Residue, Fast_Soil, Slow_Soil, Passive_Soil, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))
 
}


temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  mutate(Soil_Carbon_Concentration = Soil_Carbon_Concentration/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))


Difference.df <-  temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  pivot_wider(names_from = model,
              values_from = Soil_Carbon_Concentration) %>%
  mutate(Difference = `Five Pool` - `One Pool`) 




###Graphs for within 1% of each other

temp1 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 1e-2))%>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))

temp.01 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 1e-3))%>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))

temp5 <- Difference.df %>%
  mutate("Normalized Difference to Five Pool model" = Difference/`Five Pool`) %>%
  mutate("Close to Five Pool" = (abs(`Normalized Difference to Five Pool model`) <= 1e-2)) %>%
  mutate("Normalized Difference to OG steady state" = Difference/sum(FivePool_SS.fn(parms = Params_FivePool.ls))) %>%
  mutate("Close" = (abs(`Normalized Difference to OG steady state`) <= 5e-2)) %>% 
         filter(Close == "TRUE") %>%
         mutate("NPP Shift" = as.numeric(inputs_shift))


temp_graph <- ggplot(temp5) + 
  geom_point(aes(y=time, x=`NPP Shift`), color = "gray", size = 1, shape = 15, alpha = 0.01) +
  geom_point(data = temp1, aes(y=time, x=`NPP Shift`, color = inputs_shift), size = 0.5, shape = 1) +
  geom_point(data = temp.01, aes(y=time, x=`NPP Shift`), size = 1, shape = 4) +
  labs(title = "Length of Simulation where Models agree",
       subtitle = "One-pool within 5%, 1%, and 0.1% of the five-pool",
       y = "Time (years)",
       x = "Relative Shift in NPP (%)",
       color = "Shift") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) + 
  theme_bw() +
  theme(text = element_text(size = 9),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        plot.title = element_text(size = 10),
        plot.subtitle = element_text(size = 7),
        legend.title = element_text(size = 6),
        legend.position = "none") 

#ggsave("Figures/RegimeShift_SOC_Difference_bypercent.pdf",
#        plot = temp_graph,
#         device = pdf,
#        width = 8.7,
#        height = 6,
#        units = "cm")

temp_graph

```
# Using a RK integration to test model agreement

```{r Difference Calculations}
#Resolutoin of forward run set here for easy changing later
time_step_resolution <- 1/12
#End of simulation set here for easy change later
max_time <- 10000

#Set the granularity of the NPP shift
NPP_shifts <- c(seq(0.5, 0.99, by = 0.01),seq(1.01, 1.5, by = 0.01))

#Set the model agreement you desire (what's the maximum difference you will tolerate)
max_diff <- 0.05

Mature_Soil_FivePools <- c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls))

Mature_Soil_OnePool <- c("Cumulative_Respiration" = 0, 
                                  "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls)))

RK_timestep.fn <- function(ODE.fn,
                           ODE_parms,
                           first_point,
                           first_time,
                           time_step = time_step_resolution,
                           method = "Euler"
)  { 
  
  
  k1 <- ODE.fn(t = first_time,
               y = first_point, 
               parms = ODE_parms)[[1]]
  
  
  if (method == "Euler"){
    
    return(first_point + k1*time_step)
    
  }else{
    stop("Methods using midpoint not developed yet, please use Euler for now.")
    # ODE_drivers_mid <- (ODE_drivers_first + ODE_drivers_second) / 2
    # 
    # k2 <- ODE.fn(y = first_point + k1*(time_step/2), 
    #              parms = ODE_parms,
    #              drivers = ODE_drivers_mid)[[1]]
    # 
    # if (method == "Second Midpoint"){
    #   
    #   return(first_point + k2*time_step)
    #   
    # }else{
    #   
    #   k3 <- ODE.fn(y = first_point + k2*(time_step/2), 
    #                parms = ODE_parms,
    #                drivers = ODE_drivers_mid)[[1]]
    #   
    #   k4 <- ODE.fn(y = first_point + k3*time_step,
    #                parms = ODE_parms,
    #                drivers = ODE_drivers_second)[[1]]
    #   
    #   return(first_point + ((k1 + 2*k2 + 2*k3 + k4)/6)*time_step)
    #   
    #}
  }
}


tic <- Sys.time()

for(j in NPP_shifts){
  
    #Make an empty dataframe with proper col names to fill
    Max_Model_Agreement <- data.frame(NPP_shift = NA,
                                      Time = NA)

for(i in seq(0, max_time, by = time_step_resolution)){
  
  if(i == 0){
    

    
    # Forward_run <- data.frame("Hour" = 0,
    #                           "Difference" = 0) %>%
    #   as.data.frame()
    
    Five_Pools <- RK_timestep.fn(ODE.fn = FivePool_ODE.fn,
                           ODE_parms = Params_FivePool.ls,
                           first_point = Mature_Soil_FivePools,
                           first_time = i,
                           time_step = time_step_resolution,
                           method = "Euler")

    
    Five_Pool_Endpoint_Approx <- Five_Pools 
    Five_Pools_sum <- sum(Five_Pools) - Five_Pools["Cumulative_Respiration"]
    
    One_Pool <- RK_timestep.fn(ODE.fn = OnePool_ODE.fn,
                           ODE_parms = Params_Aggregate.ls,
                           first_point = Mature_Soil_OnePool,
                           first_time = i,
                           time_step = time_step_resolution,
                           method = "Euler"
      
    )
    
    One_Pool_Endpoint_Approx <- One_Pool
    
    
    Model_Difference <- One_Pool["Soil_Carbon_Concentration"] - Five_Pools_sum 
    
    
    # Forward_run <- rbind(Forward_run,
    #                      data.frame("Hour" = i + time_step_resolution,
    #                                 "Difference" = Model_Difference))
    
          
  }else{
    
    
    Five_Pools <- RK_timestep.fn(ODE.fn = FivePool_ODE.fn,
                           ODE_parms = Params_FivePool.ls,
                           first_point = Five_Pool_Endpoint_Approx,
                           first_time = i,
                           time_step = time_step_resolution,
                           method = "Euler")

    
    Five_Pool_Endpoint_Approx <- Five_Pools 
    Five_Pools_sum <- sum(Five_Pools) - Five_Pools["Cumulative_Respiration"]
    
    One_Pool <- RK_timestep.fn(ODE.fn = OnePool_ODE.fn,
                           ODE_parms = Params_Aggregate.ls,
                           first_point = One_Pool_Endpoint_Approx,
                           first_time = i,
                           time_step = time_step_resolution,
                           method = "Euler"
                           
    )
    
    
    Model_Difference <- One_Pool["Soil_Carbon_Concentration"] - Five_Pools_sum
    
    if(abs(Model_Difference)/Mature_Soil_OnePool["Cumulative_Respiration"] >= max_diff){
      
      
      break
      
    }
    # Forward_run <- rbind(Forward_run,
    #                      data.frame("Hour" = i + time_step_resolution,
    #                                 "Difference" = Model_Difference))
    
    
  }

}


Max_Model_Agreement <- rbind(Max_Model_Agreement,
                             data.frame(NPP_shift = j,
                                        Time = i)
                             )
}

toc <- Sys.time()

toc - tic 
# 3.842853 secs secs for one five-pool run, 100 years, monthly
# 0.4154561 secs secs for difference between one and five pools for 100 years, monthly
# 15.73555 secs secs secs for difference between one and five pools for 1000 years, monthly
# 0.09623694 secs for a max time calculation for NPP shift of 90%

# ggplot(Forward_run) +
#   geom_line(aes(x = Hour, y = Difference))

```


```{r CLOSER eval = FALSE}

Max_Model_Agreement1 <- data.frame("time" = NA,
                                     "inputs_shift" = NA)

for(i in NPP_shifts){
  temp_max <- temp1 %>%
    select(c(time, inputs_shift)) %>%
    filter(inputs_shift == i)
  
  Max_time <- max(temp_max$time)
  
  temp_max <- temp_max %>%
    filter(time == max(Max_time))

  Max_Model_Agreement1 <- full_join(Max_Model_Agreement1, temp_max, by = join_by(time, inputs_shift)) 
}

ggplot(Max_Model_Agreement1) + 
  geom_point(aes(x=inputs_shift, y=time))

Hundred_Years_agreement <- Max_Model_Agreement1 %>%
  filter(time == 100)

test_range <- seq(as.numeric(min(Hundred_Years_agreement$inputs_shift)), 
                  as.numeric(max(Hundred_Years_agreement$inputs_shift)),
                  by = .001)


SimTimes <- seq(0, 2e4, by = 1/6)


#creating an empty data frame to populate through for loop
NPPshift_Sim1.df <- data.frame(time=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in test_range){

Params_Aggregate.ls$NPPshift <- i 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))),
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Input_Rate = Params_Aggregate.ls$inputs.fn(t = time,
                                                  parms = Params_Aggregate.ls),
         .by = everything()) %>%
  mutate(inputs_shift = as.character(i) )
 
 NPPshift_Sim1.df <- full_join(NPPshift_Sim1.df, 
                               temp, 
                               by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))

}


####FIVE POOL SIMULATIONS
##Add needed function to parameter list for Five Pool simulations

#creating an empty data frame to populate through for loop
NPPshift_Sim5.df <- data.frame(time=as.numeric(),
                               Metabolic_Plant_Residue=as.numeric(),
                               Structural_Plant_Residue=as.numeric(),
                               Fast_Soil=as.numeric(),
                               Slow_Soil=as.numeric(),
                               Passive_Soil=as.numeric(),
                               Soil_Carbon_Concentration=as.numeric(),
                               Respiration_Rate=as.numeric(),
                               Input_Rate=as.numeric(),
                               inputs_shift=as.character())

for(i in test_range){

Params_FivePool.ls$NPPshift <- i 

 temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)),
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Input_Rate = Params_FivePool.ls$inputs.fn(t = time,
                                                  parms = Params_FivePool.ls),
         .by = everything()
  ) %>%
  mutate(inputs_shift = as.character(i) )
 
  NPPshift_Sim5.df <- full_join(NPPshift_Sim5.df, 
                               temp,
                               by = join_by(time, Metabolic_Plant_Residue, Structural_Plant_Residue, Fast_Soil, Slow_Soil, Passive_Soil, Soil_Carbon_Concentration, Respiration_Rate, Input_Rate, inputs_shift))
 
}


temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  mutate(Soil_Carbon_Concentration = Soil_Carbon_Concentration/sum(FivePool_SS.fn(parms = Params_FivePool.ls)))


ggplot(temp) + 
  geom_line(aes(x=time, 
                y=Soil_Carbon_Concentration,
                color=inputs_shift, 
                linetype = model)) + 
  scale_x_log10() +
  labs(title = "Regime Shift: Log10 scaled time",
       y = "Ratio of SOC to initial value",
       x = "Time (years)") +   
  theme(legend.position = "none") 
  


Difference.df <-  temp <- full_join(NPPshift_Sim1.df %>%
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "One Pool"), 
                  NPPshift_Sim5.df %>% 
                    select(c("time", "Soil_Carbon_Concentration", "inputs_shift")) %>%
                    mutate(model = "Five Pool")) %>%
  pivot_wider(names_from = model,
              values_from = Soil_Carbon_Concentration) %>%
  mutate(Difference = `Five Pool` - `One Pool`) 


```






# Sensitivity to inputs vector Ratios

What if the inputs vector changes, i.e. faster-decaying or slower-decaying plants?

```{r}

###Creates Parameters - shifting the input vector structural-metabolic C ratio
Params_FivePool_shift_fast.ls <- Params_FivePool.ls
Params_FivePool_shift_fast.ls$input_to_meta <- 8/9 #Originally 7/9
Params_FivePool_shift_fast.ls$input_to_struc <- 1 - Params_FivePool_shift_fast.ls$input_to_meta 
  #defines other litter parameter so that their total is 1

Params_FivePool_shift_slow.ls <- Params_FivePool.ls
Params_FivePool_shift_slow.ls$input_to_meta <- 6/9 #Originally 7/9
Params_FivePool_shift_slow.ls$input_to_struc <- 1 - Params_FivePool_shift_slow.ls$input_to_meta
  #defines other litter parameter so that their total is 1


#Creating the Aggregate Decay Rates from the new Five-Pool Parameters
Params_Aggregate_shift_fast.ls <- list(ave_inputs = Params_FivePool.ls$ave_inputs,
                            turnoverTime = Proxy_decayrate.fn(parms = Params_FivePool_shift_fast.ls)
                            )

Params_Aggregate_shift_slow.ls <- list(ave_inputs = Params_FivePool.ls$ave_inputs, 
                            turnoverTime = Proxy_decayrate.fn(parms = Params_FivePool_shift_slow.ls)
                            )

###Need a constant inputs function:
constant_inputs.fn <- function(time, parms){
  
    u <- parms$ave_inputs
  
  return(u)
}

Params_Aggregate_shift_fast.ls$inputs.fn <- constant_inputs.fn
Params_Aggregate_shift_slow.ls$inputs.fn <- constant_inputs.fn
Params_FivePool_shift_slow.ls$inputs.fn <- constant_inputs.fn
Params_FivePool_shift_fast.ls$inputs.fn <- constant_inputs.fn


## ONE POOL SIMs
temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
            "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))), ##Initial Value uses original parameters
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate_shift_fast.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate_shift_fast.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Litter_Decays = "Faster")

Litter_Input_Ratio_OnePool <- full_join(temp, lsoda(y = c("Cumulative_Respiration" = 0, 
            "Soil_Carbon_Concentration" = sum(FivePool_SS.fn(parms = Params_FivePool.ls))), ##Initial Value uses original parameters
                times = SimTimes,
                func = OnePool_ODE.fn,
                parms = Params_Aggregate_shift_slow.ls) %>%
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Respiration_Rate = OnePool_ODE.fn(t = 1, 
                                           y = c(NA, Soil_Carbon_Concentration),
                                           parms = Params_Aggregate_shift_slow.ls
                            )[[1]]['Cumulative_Respiration'],
          .by = everything()
    ) %>%
  mutate(Litter_Decays = "Slower"),
  by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Litter_Decays)
)

ggplot(Litter_Input_Ratio_OnePool) + 
  geom_line(aes(x=time, y=Soil_Carbon_Concentration, linetype = Litter_Decays))
  

## FIVE POOL SIMs

Litter_Input_Ratio_FivePool_faster <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)),##Initial Value uses original parameters
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool_shift_fast.ls) %>% 
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool_shift_fast.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Litter_Decays = "Faster")


Litter_Input_Ratio_FivePool_slower <- lsoda(y = c("Cumulative_Respiration" = 0, 
                                  FivePool_SS.fn(parms = Params_FivePool.ls)), ##Initial Value uses original parameters
                times = SimTimes,
                func = FivePool_ODE.fn,
                parms = Params_FivePool_shift_slow.ls) %>% 
  as.data.frame() %>%
  select(!c(Cumulative_Respiration)) %>%
  mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
  mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
                                           y = c("Cumulative_Respiration" = 0, 
                                                Metabolic_Plant_Residue = Metabolic_Plant_Residue,
                                                Structural_Plant_Residue = Structural_Plant_Residue,
                                                Fast_Soil = Fast_Soil,
                                                Slow_Soil = Slow_Soil,
                                                Passive_Soil = Passive_Soil),
                                            parms = Params_FivePool_shift_slow.ls
                                  )[[1]]['Cumulative_Respiration'],
          .by = everything()
    )%>%
  mutate(Litter_Decays = "Slower")

Litter_Input_Ratio_FivePool <- full_join(Litter_Input_Ratio_FivePool_faster,
                                         Litter_Input_Ratio_FivePool_slower,
  by = join_by(time, Soil_Carbon_Concentration, Respiration_Rate, Litter_Decays)
)

ggplot(Litter_Input_Ratio_FivePool) + 
  geom_line(aes(x=time, y=Soil_Carbon_Concentration, linetype = Litter_Decays))


ggplot(Litter_Input_Ratio_FivePool_faster %>%
         pivot_longer(Metabolic_Plant_Residue:Passive_Soil,
                      names_to = "Pool",
                      values_to = "SOCC"
                      )) + 
  geom_line((aes(x=time, y=SOCC, color=Pool))) +
  labs(title="Faster litter decay, by pool")


ggplot(Litter_Input_Ratio_FivePool_slower %>%
         pivot_longer(Metabolic_Plant_Residue:Passive_Soil,
                      names_to = "Pool",
                      values_to = "SOCC"
                      )) + 
  geom_line((aes(x=time, y=SOCC, color=Pool)))+
  labs(title="Slower litter decay, by pool") + 
  scale_x_log10()





# ###TESTING SS with new parameters
# ######Works now, commented out to avoid running excess unneeded code
# 
# temp <- lsoda(y = c("Cumulative_Respiration" = 0, 
#                                   FivePool_SS.fn(parms = Params_FivePool_shift_slow.ls)), ##Initial Value uses new parameters to test steady state
#                 times = SimTimes,
#                 func = FivePool_ODE.fn,
#                 parms = Params_FivePool_shift_slow.ls) %>% 
#   as.data.frame() %>%
#   select(!c(Cumulative_Respiration)) %>%
#   mutate(Soil_Carbon_Concentration = Metabolic_Plant_Residue + Structural_Plant_Residue + Fast_Soil + Slow_Soil + Passive_Soil) %>%
#   mutate(Respiration_Rate = FivePool_ODE.fn(t = 1, 
#                                            y = c("Cumulative_Respiration" = 0, 
#                                                 Metabolic_Plant_Residue = Metabolic_Plant_Residue,
#                                                 Structural_Plant_Residue = Structural_Plant_Residue,
#                                                 Fast_Soil = Fast_Soil,
#                                                 Slow_Soil = Slow_Soil,
#                                                 Passive_Soil = Passive_Soil),
#                                             parms = Params_FivePool_shift_slow.ls
#                                   )[[1]]['Cumulative_Respiration'],
#           .by = everything()
#     )
# 
# FivePool_ODE.fn(t = 0,
#                 y=c("Cumulative_Respiration" = 0, 
#                                   FivePool_SS.fn(parms = Params_FivePool_shift_slow.ls)),
#                 parms = Params_FivePool_shift_slow.ls)
# 
# 
# FivePool_SS.fn(parms = Params_FivePool.ls)
# FivePool_SS.fn(parms = Params_FivePool_shift_slow.ls)
# 
# ggplot(temp) + 
#   geom_line(aes(x=time, y=Soil_Carbon_Concentration))
# 
# temp <- temp %>% pivot_longer(Metabolic_Plant_Residue:Passive_Soil,
#                               names_to = "Pool",
#                               values_to = "SOCC")
# ggplot(temp) + 
#   geom_line(aes(x=time, y=SOCC, color=Pool))+
#   scale_x_log10()

```




