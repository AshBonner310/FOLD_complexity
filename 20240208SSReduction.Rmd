---
title: "Steady State Reduction"
author: "Ashley Bonner"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
#useful functions in here

library(tidyverse) #data library
library(deSolve) #ODE solver
library(DiagrammeR) #flow charts
library(patchwork) #cool figure arrangment

knitr::opts_chunk$set(echo = TRUE)
```

# A standard one pool model

The rate of change of soil carbon stocks is the balance between the inputs and the outputs because of conservation of mass -- carbon is neither created nor distroyed.
In this simple one pool model we assume a constant input rate ($u$; [mass per area per time]).
The outputs are assumed to be proportional to the stock that is there.
There are other functional forms that could also use but this is the simplest (and also happens to fit incubation experiments).

$\frac{dC}{dt} = u - kC$

where 

  + $C$ is the carbon stock [mass per area]. This is often on the order of 1 to 150 kg-organic-carbon m^-2^ for the first meter of soil (HWSD2)
  + $u$ is the inputs into the soil [mass per area per time]. Between root exodase, root turnover, and surface litter, inputs are difficult to quantify directly. However net primary productivity is often used as a proxy for soil inputs and varies between 0 to 2.5 kg-organic-carbon m^-2^ yr^-1^ with the geographic mode occurring around 0.2 kg-C m^-2^ yr^-1 (MODIS - MOD17A3)
  + $k$ is the decay rate is the fraction of carbon leaving the soil carbon pool per time. This is often framed as it's inverse, turnover time ($k=\frac{1}{\tau}$) which has many interpretation but for this model is the average length of time a carbon atom will spend in the soil. The bulk turnover time in Earth system models is on the order of 10 to 50 years (CMIP5 and CMIP6).
  
From this model we can calculate the steady state value, where the rate of change is zero.
This describes the carbon stock that the system is trending towards as it matures.

$C_{ss} = \frac{u}{k} = u k^{-1} = u\tau$

This also gives us a useful check on our ranges if we assume that soil carbon stocks are generally close to steady state. 
$u\tau = [0, 0.2, 2.5] [10, 15, 50] = [0, 3, 125]$

It's very very close to the stated ranges for the soil carbon stocks of $[1,150] \frac{kg-C}{m^2 yr^1}$.

We can also look at the inputs and carbon stocks to infer the turnover times.
$\frac{C}{u} \left( \frac{kgC/m^2}{kgC/m^2yr }\right)= \frac{[1, 150]}{[0.1, 2.5]} = [0.4, 1500] \left( yr \right)$
which is a MUCH larger range of turnover times.
So this would be consistent with the observations but maybe not constraining of the parameters.

```{r OnePool}
century_parameter.ls <- list(inputs = 0.2/12, 
                                #u; [0, 2.5] kg-carbon m-2 yr-1; split per month (to fit CENTURY parameters)
                              turnoverTime = 15*12
                                #\tau; [10, 50] yr, by month
                             
                             ) 
simTime <- 100*12

#rate of change function
dCdt_1pool <- function(t, y, parms, rel_tol = 1e-8){
  ## Debugging code below
  #t <- 0
  #y <- c(G = 0, InitialCarbon_1pool)
  #parms <- parameter.ls
  y <- unname(y)
  CO2 <- y[1] 
  soil <- y[2]
  
  dCO2 <- soil / parms$turnoverTime
  dSoil <- parms$inputs - soil / parms$turnoverTime
  
  #make a relative tolerance to ensure conservation of mass
  if(parms$inputs != 0){ 
    #need this to keep the no-inputs simulation running
    if(abs(parms$inputs - (dCO2 + dSoil))/parms$inputs > rel_tol){ 
      #relative tolerance allowance
        stop('Conservation of mass does not hold')
    }
  }
  return(list(c(G = dCO2, C_total = dSoil)))
}

#steady state function
SS_1pool <- function(parms){
    ans <- parms$inputs * parms$turnoverTime
  return(c(G = 0, C = ans))
}


ggplot(lsoda(y = SS_1pool(parms=century_parameter.ls)*0.7,
                times = seq(0, simTime, by = 1/10),
                func = dCdt_1pool,
                parms = century_parameter.ls) %>%
          as.data.frame()
       ) + 
  geom_line(aes(x=time, y=C)) +
  geom_line(data = lsoda(y = SS_1pool(parms=century_parameter.ls),
                times = seq(0, simTime, by = 1/10),
                func = dCdt_1pool,
                parms = century_parameter.ls) %>%
          as.data.frame(), aes(x=time, y=C), linetype="dotted")


```
Tracking carbon stocks in soil is important to understanding how much carbon could be sequestered, and helps to answer questions around whether soil could serve as a carbon sink or as a source across diverse ecosystems as our climate changes.
Another important metric we will be considering is how much CO$_2$ is respired over a certain period of time.
This largely depends on where the model starts, but discussing the basics here seems pertinent.


#The three-pool feedback model

CENTURY is our basis for parametrization, and this model uses **monthly** timesteps. This model was developed and parametrized on spring wheat farms in the northern Great Plains.

Soil is fractioned into three pools: Active, Slow, and Passive soil C. 
The *Active* or *Fast* pool is considered to be the soil carbon fraction of "live microbes and microbial products".
The *Slow* pool is considered to be a fraction that is "more resistant to decomposition... as a result of physical or chemical protection".
The *Passive* pool is the final fraction believed to be even more chemically resistant of physically protected.

```{r Diagram, echo = FALSE}
grViz("
  digraph Three_Pool_Model {
    rankdir=LR
    
    subgraph outside_the_system{ 
    node[ shape = oval,
          font = Baskerville,
          style=dashed]
    Inputs; CarbonDioxide
    }
    
    Inputs  -> Fast     [headport=w, color = red3]; 
    Inputs  -> Slow     [headport=w, color = purple3]; 
    Inputs  -> Passive  [headport=w, color = blue3];
    Fast    -> CarbonDioxide [tailport=n, color = red3]; 
    Slow    -> CarbonDioxide [tailport=n, color=purple3]; 
    Passive -> CarbonDioxide [tailport=n, color=blue3]
    
      subgraph cluster_SoilPools {
        label = 'Soil Pools'
    
        node[ shape = box,
              font = Baskerville,
              style=solid]
        rank = same
          
        Fast[color=red3, fontcolor=red4]; Slow[color=purple3, fontcolor=purple4]; Passive[color=blue3, fontcolor=blue4]
        
        #Fluxes out of Fast
        Fast -> Slow[tailport=n, color = MediumVioletRed]
        Fast -> Passive[tailport=n, color = DarkViolet]
        
        #Fluxes out of Slow
        Fast -> Slow [dir=back, color = MediumVioletRed, headport = n]
        Slow -> Passive[tailport=n, color = SlateBlue3]
        
        #Fluxes out of Passive
        Fast -> Passive[dir=back, color=DarkViolet, headport = n]
        Slow -> Passive[dir=back, color=SlateBlue3, headport = n]
      }
    }
  }
")

```

The model has the equation

$$\frac{dC}{dt} = u\vec{b} - \boldsymbol{K}\boldsymbol{A}\vec{C}$$

where $\vec{C}$ is a vector representing our three state variables, $\vec{b}$ is a vector that divides up the carbon inputs into the soil system into the three types of carbon represented by our pools; this value $u$ is often estimated as a fraction of vegetation's net primary production.
The matricx $\boldsymbol{K}$ s a diagonal matrix containing the decay rates of the pools.
The allocation matrix $\boldsymbol{A}$ can be diagonal (for a model where the pools are independant and have no fluxes betwen them), lower-triangular (for a cascade model, where carbon flows from simpler forms to more complex forms due to the ecological principal of trophic cascades), or fully dense (for a model that allows carbon to move freely between the pools).
In any of these three cases, the diagonal entries are all positive one, and the off-diagonal entries are nonpositive (negative or zero), and the columns will always sum to a positive value less than one.
If we let the entries of $\boldsymbol{A}$ be $f_{ij}$, where $i$ is the column and $j$ is the row, this becomes:

$$\frac{dC_1}{dt} = ub_1 - k_1C_1 +k_2f_{12}C_2 + k_3f_{13}C_3 \\
\frac{dC_2}{dt} = ub_2 - k_2C_2 +k_1f_{21}C_1 + k_3f_{23}C_3 \\
\frac{dC_3}{dt} = ub_3 - k_3C_3 +k_1f_{31}C_1 + k_2f_{32}C_2$$

The flows out of the soil pools are the respiration of the system, as

$$\frac{dG}{dt} = (1-f_{12}-f_{13})k_1C_1 + (1-f_{21}-f_{23})k_2C_2 + (1-f_{31}-f_{32})k_3C_3$$
or, the grand sum (sum of all the entries) of $\boldsymbol{K}\boldsymbol{A}\vec{C}$.


```{r ThreePoolODE}

dCdt_Century <- function(t, y, parms){
  G <- y[1]
  pools <- matrix(y[2:4], nrow=3)
  allocation_matrix <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
    decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
    transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
   ans <- parms$inputs * allocation_matrix - decay_matrix %*% transfer_matrix %*% pools
  
    resp <- decay_matrix %*% transfer_matrix %*% pools
   total_resp <- sum(resp)
  
  return(list(c(G = total_resp,
                C_fast = ans[1],
                C_slow = ans[2],
                C_passive = ans[3]
  )))
}
```

##Parametrization

###Decay Rates
These soil pools were modelled with fixed decay rates.
The ranges for these decay rates by pool are considered to be 2-4 years for the active pools, 20-50 years for the slow pool, and 800-1200 years for the passive pool.
The overall average turnover times based on the 1988 CENTURY paper:
 - Active: 1.5 years average (18 months)
 - Slow: 25 years average (300 months)
 - Passive: 1,000 years average (12,000 months).
 
###Cycle Flows
Fluctuation between the pools is sometimes explicit and fixed in the original paper, although one is reliant on other conditions. 
These fixed flows are:
 - Active into Passive: 0.4% of decay
 - Slow into Active: 42% of decay
 - Slow into Passive: 3% of decay
 - Passive into Active: 45% of decay.
 
 CENTURY does not include a flow from the Passive Pool into the Slow pool, so 
 - Passive into Slow: 0% of deacy.
 
The flow from Active into Slow is based on the silt and clay content of the soil. 
High silt and clay content results in a lower fraction  respired from the active pool, and instead cycles into the Slow pool.
If we assume an "ideal" mixture for agricultural soil, then we have 40% silt and 20% clay (the other 40% sand). (Maine.gov:https://www.maine.gov/dacf/mgs/education/lessons/act31.pdf, maybe I should find a more academic source for this?)
Then the amount respired from the active pool as CO$_2$ is $F(T=.6) = .85-.68(.6) = .442$, or 44.2%.
Thus, the rate of the flow from the Active pool into the slow pool is the the percentage left after taking out respiration and the cycled flow into the Passive pool:
 - Active into Slow: 55.4% of decay
 
 This also means the range of this flow is anywhere from $1-.85-.04=$14.6% for zero-clay soils to $1-(.85-.68)-.004=$82.6% for completely-clay soil.
 
###Allocation of Inputs
The allocation of the inputs into the three pools is a bit trickier.
Century's carbon model divides plant residue into Structural C and Metabolic C litter pools based on a function of the Lignin to Nitrogen fraction (this function is not specified in the 1988 CENTURY paper). 
This is calculated with the help of an N submodel in Century, but we will consider that the metabolic / structural C split of plant residue to be a seven-to-one ratio for our own computations. 
From there, 45% of the Metabolic C litter pool enters the Active soil pool directly.
The flows from the Structural C litter pool into the Active and Slow soil pools is first broken up based on the lignin fraction.
This lignin fraction is not explicitly mentioned outside of the model diagram in the 1988 paper.
Due to the varying decay rates of the two litter pools (3 years on average for structural and half a year on average for metabolic), and the fact that these two pools are independent of any flows other than a driving input term and a decay term, we can solve for their steady states. 
If inputs are assumed to be one "unit" (we are ultimately looking for a percentage here), and the time is in months, then the Structural pool has a steady state at (0.125)36 = 4.5, and the Metabolic is at (0.875)6 = 5.25, and the total C in litter pools at steady state is 9.75 "units".
Now 45% of the metabolic pool enters the Active soil pool, so this is 45% of 4.5 units, or 2.025 units.
The flow out of the Structural C pool splits based on the lignin fraction.
Of the portion of the flow equal to the lignin fraction, 70% enters the Slow pool.
Of the rest, either 45% for leaves or 55% for roots is respired as CO$_2$ and the rest of those fractions enters the Active soil pool as well (we will use 50% on the whole here for simplicity).


```{r Parameters}
#Calculating Variable Century model parameters
varying_century_params <- list(
  SMsplit =  1/8,
    #fraction of plant residue that is structural rather than metabolic
  structural_turnover = 36,
    #in months
  metabolic_turnover = 6,
    #in months
  lignin_frac = .5,
    #using a placeholder here, still uncertain.
  silt_clay_frac = .4 + .2
)

Input_Allocation.fn <- function(parms){
  FastInput <- with(varying_century_params, {
    (((1-SMsplit)*metabolic_turnover) *
      #metabolic litter pool steady state if 1 "unit" enters litter pools every month
        0.45) +
      #45% goes into active
    ((SMsplit*structural_turnover) * 
      #structural steady state if 1 "unit" enters litter pools every month (time step)
        (1-lignin_frac) *
      #split of flow out of structural pool
        0.5)
      #percent that actually enters the active soil pool
        #note that century somehow breaks this up into surface litter (leaves) and belowground root exudates and turnover. Unclear exactly how this works, so we are using the average between the two.
  })
  
  SlowInput <- with(varying_century_params, {
    ((SMsplit*structural_turnover) * 
      #structural steady state if 1 "unit" enters litter pools every month (time step)
        lignin_frac *
      #split of flow out of structural pool
        0.7)
      #percent that actually enters the slow soil pool
  })
  
  FastPercent <- FastInput/(FastInput + SlowInput)
  SlowPercent <- SlowInput/(FastInput + SlowInput)
  
  return(c("FastPercent" = FastPercent, "SlowPercent" = SlowPercent))
}


century_parameter.ls <- list(
  inputs = 0.2/12, 
      #monthly; divided evenly between the months
  input_to_fast = Input_Allocation.fn(parms=varying_century_params)[1], 
      #((.125)+(.875*.5)),  
  input_to_slow = Input_Allocation.fn(parms=varying_century_params)[2], 
      #.875*.5,  
  #note: Century includes no direct inputs to the passive pool.
  
  turnoverTime_fast = 1.5*12, #1.5y 
      #fast turnover according to Century \tau \in [2, 4] yr  
  turnoverTime_slow = 25*12,  #25y
      #slow turnover according to Century \tau \in [20, 50] yr
  turnoverTime_passive = 1000*12, #1000y
      #passive turnover according to Century \tau \in [800, 1200] yr
    
  fast_to_slow = 1-(0.85-(0.68*varying_century_params$silt_clay_frac))-.004,       
      #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
   fast_to_passive = 0.004,    
   slow_to_fast = 0.42,
   slow_to_passive = 0.03,     
   passive_to_fast = 0.45,     
   passive_to_slow = 0         
    # CENTURY does not include this last flow
)

```

##Steady State for the Three-pool model

One of the special properties of the matrix $\boldsymbol{K}\boldsymbol{A}$ is that it is an M-matrix, and importantly, is invertible. 
The means that we can solve directly for steady state:

$$ \frac{d\vec{C}}{dt} = 0 \implies \boldsymbol{K}\boldsymbol{A}\vec{C} = u\vec{b} \implies \vec{C} = u \left( \boldsymbol{K}\boldsymbol{A} \right)^{-1} \vec{b} $$
Using this steady state, we can then use a fraction of as an initial value to run a simulation, just for the purposes of verifying our steady state is correct and to evaluate a basic behavior of the system.

```{r SS-n-Simumlation}

#steady state calculations for each pool
SS_Century <- function(parms){
  allocation_vector <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
  #0 = inputs * allocation - decay_matrix %*% transfer_matrix %*% y
  #decay_matrix %*% transfer_matrix %*% y = inputs * allocation
  
  ans <- solve(decay_matrix  %*% transfer_matrix ,parms$inputs * allocation_vector)
  
  return(c(C_fast = ans[1],
           C_slow = ans[2],
           C_passive = ans[3]))
}

#making a more realistic simulation time for a monthly model with turnover times in the 1000s
simTime <- 5e3*12

#simulation
sim_Century <- lsoda(y = c(G=0, 
                           SS_Century(parms = century_parameter.ls)*0.5),
                      times = 0:simTime,
                      func = dCdt_Century,
                      parms = century_parameter.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = C_fast + C_slow +C_passive) 


#Feedback graph by pools:
Century_spinup_facet_graph <- ggplot(sim_Century %>%
         pivot_longer(cols = C_fast:C_passive,
                      names_to = 'pool',
                      values_to = 'stock')%>%
         mutate(pool = factor(pool, levels = c('C_fast', 'C_slow', 'C_passive')),
                model = '3feedback')
        ) +
  geom_line(aes(x=time, y=stock, color = model)) +
  facet_wrap(~ pool, ncol=1, scales='free')

#Feedback graph with pools stacked:
Century_spinup_stack_graph <- ggplot(sim_Century %>%
         pivot_longer(cols = C_fast:C_passive,
                      names_to = 'pool',
                      values_to = 'stock')%>%
         mutate(pool = factor(pool, levels = c('C_fast', 'C_slow', 'C_passive')),
                model = '3feedback')
) +
  geom_area(aes(x=time, y=stock, fill = pool)) +
  xlim(0,12*2.5e2)


#print graphs with regular and log-scale time
Century_spinup_facet_graph
Century_spinup_facet_graph + scale_x_log10()
Century_spinup_stack_graph
#Century_spinup_stack_graph + scale_x_log10()
  ##honestly, this last one is not as interesting, especially with the difference
```

## A One-pool Proxy Decay Rate for the Three-pool model

-text here-

```{r Proxy-Decay-Rate}
##One Pool Proxy Method:

#Proxy Decay Rate Calculation
Proxy_decayrate <- function(parms){
    decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  
    transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
  
    allocation_vector <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
  
    ans <- sum(solve(decay_matrix %*% transfer_matrix) %*% allocation_vector)
    
  return(ans)
}  

##Adds the proxy rate to the main parameter list
century_parameter.ls$turnoverTime <- Proxy_decayrate(parms=century_parameter.ls)


#Initial Value for the One Pool Proxy, simulation, with name for lsoda output
InitialCarbon_1pool <- sum(SS_Century(parms = century_parameter.ls))*0.75

#Simulation with the one-pool model
sim_Proxy <- lsoda(y = c(G=0, 
                                    #C_total = 0), #use for full range of carbon stocks comparison?
                                    C_total = InitialCarbon_1pool),
                                    times = 0:simTime,
                                    func = dCdt_1pool,
                                    parms = century_parameter.ls) %>%
                          as.data.frame() 


sim_all <- sim_Century %>%
  full_join(sim_Proxy, by = 'time', suffix = c('.3pool', '.proxy')) %>%
  mutate(flux_3pool = dCdt_Century(t = time, y = c(0, C_fast, C_slow, C_passive),
                                     parms = century_parameter.ls)[[1]][1],
         flux_proxy = dCdt_1pool(t = time, y = c(0, C_total.proxy),
                                     parms = century_parameter.ls)[[1]][1], .by= everything())


#difference drive graph
ggplot(sim_all) +
  geom_point(aes(x=C_fast+C_slow+C_passive, y = C_total.proxy)) +
  geom_abline()+
  labs(title="Total SOC Stocks Between the Models", y="One-Pool with Proxy Decay Rate", x="Three-Pool First-Order Linear Decay")

#Total SOC over time
ggplot(sim_all) +
  geom_line(aes(x=time/12, y= C_total.proxy), color = "#0021A5") +
  geom_line(aes(x=time/12, y = C_fast+C_slow+C_passive), color = "#FA4616") +
  labs(title="Total Soil Organic Carbon Stock", y="Total Soil Organic Carbon Stocks (kg C / m^2)", x="Time (yrs)")+
  xlim(0,200)

  #notes for colors: (Gator Colors)
  #+ scale_color_manual(values=c("#FA4616", "#0021A5")) 


#Some data cleaning for graph matching the no-inputs comparison below
sim_Proxy <- sim_Proxy %>%  mutate(model="Proxy") %>%
                            mutate(dCO2dt = dCdt_1pool(t=NA, y=c(G=0, C_total), parms= century_parameter.ls)[[1]]["G"], .by=everything() )

sim_Century <- sim_Century %>% 
                  mutate(model="Century") %>%
                  mutate(dCO2dt = dCdt_Century(t=NA, y=c(G=0,C_fast, C_slow, C_passive), parms= century_parameter.ls)[[1]]["G"], .by=everything() )


model_comparison.sim <-  bind_rows(sim_Century, sim_Proxy)

ggplot(model_comparison.sim) +
  geom_line(aes(x=time/12, y=dCO2dt*12, color=model)) +
  xlim(0,250) +
  geom_ribbon(aes(x=time/12, ymax=dCO2dt*1.1*12, ymin=dCO2dt*0.9*12, fill=model), alpha=0.1)+
  labs(title="Carbon dioxide flux from soil over time", 
       subtitle = "starting at a fraction of steady state",
       y="CO2 flux (kg C/(m^2 yr))", 
       x="Time since carbon inputs removed (yr)",
       color = "Model", fill = "Model") +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) 


ggplot(model_comparison.sim) +
  geom_line(aes(x=time/12, y=C_total, color=model)) +
  xlim(0,250) +
  geom_ribbon(aes(x=time/12, ymax=C_total*1.1, ymin=C_total*0.9, fill=model), alpha=0.1)+
  labs(title="Soil Organic Carbon Stocks over time", 
       subtitle = "starting at a fraction of steady state",
       y="Total Soil Organic Carbon Stocks (kg C/(m^2 yr))", 
       x="Time since carbon inputs removed (yr)",
       color = "Model", fill = "Model") +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5) ) +
  scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) 




```


```{r, eval=FALSE}
ggplot(model_comparison.sim %>% mutate(dCO2dtfluxPercent = dCO2dt/C_total)) +
  geom_line(aes(x=time/12, y=dCO2dtfluxPercent, color=model)) +
  xlim(0,250) +
  #geom_ribbon(aes(x=time/12, ymax=dCO2dt, ymin=dCO2dt, fill=model), alpha=0.1)+
  labs(title="Carbon dioxide flux from soil over time AS A PERCENTAGE OF TOTAL SOIL STOCKS", 
       subtitle = "starting at a fraction of steady state",
       y="CO2 flux (kg C/(m^2 yr))", 
       x="Time since carbon inputs removed (yr)",
       color = "Model", fill = "Model") +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) 
```



## Simulating and Incubation experiment: Inputs turned off

How does this aggregate decay rate compare to the full model when soil is removed from its environment, and no new organic carbon enters the system?

```{r InputsOff}
#Times for lots of data points
Simtimes <- seq(0,(12*100), by=0.2) #12 months times years of simulation


#paramter list with no inputs
no_input_century_parameter.ls <- century_parameter.ls %>% list_assign(inputs=0)

No_inputs_feedback_sim <- lsoda(y = c(G=0, SS_Century(parms = century_parameter.ls)),
                                      times = Simtimes,
                                      func = dCdt_Century,
                                      parms = no_input_century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(C_total = C_fast + C_slow +C_passive) %>%
                          mutate(model="Century") %>%
                          mutate(dCO2dt = dCdt_Century(t=NA, y=c(G=0,C_fast, C_slow, C_passive), parms= no_input_century_parameter.ls)[[1]]["G"], .by=everything() )
                

No_inputs_one_pool_proxy_sim <- lsoda(y = c(G=0, C_total=sum(SS_Century(parms = century_parameter.ls))),
                                      times = Simtimes,
                                      func = dCdt_1pool,
                                      parms = no_input_century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(model="Proxy") %>%
                          mutate(dCO2dt = dCdt_1pool(t=NA, y=c(G=0,C_total), parms= no_input_century_parameter.ls)[[1]]["G"], .by=everything() )



no_input_model_comparison.sim <- bind_rows(No_inputs_feedback_sim, No_inputs_one_pool_proxy_sim)


#Naming and creating the plot for later patchwork
IncubationGas.plot <- ggplot(no_input_model_comparison.sim) +
  geom_line(aes(x=time/12, y=dCO2dt*12, color=model, linetype=model)) +
  xlim(0,3) 


IncubationGas.plot +
  xlim(0,100) +
  labs(title="Incubation Simulation: CO2 flux",
       subtitle = "Soil taken at steady state, removed from organic matter inputs",
       y="CO2 flux (kg C/(m^2 yr))",
       x="Time since carbon inputs removed (yr)",
       color = "Model",
       linetype = "Model"
       ) +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) # +
  # # For "uncertainty" in the model; right now just a 10% demo
  #geom_ribbon(aes(x=time/12, ymax=dCO2dt*1.1*12, ymin=dCO2dt*0.9*12, fill=model), alpha=0.1)+
  #scale_fill_manual(values=c("#FA4616", "#0021A5")) 


#Naming and creating the plot for later patchwork
IncubationStocks.plot <- ggplot(no_input_model_comparison.sim) +
  geom_line(aes(x=time/12, y=C_total, color=model, linetype=model)) +
  xlim(0,3) 
  

#A graph to show off the simulation
IncubationStocks.plot +
  xlim(0,100) +
  labs(title="Incubation Simulation: Soil Stocks",
       subtitle = "Soil taken at steady state, removed from organic matter inputs",
       y="Total Carbon Stocks (kg C/(m^2 yr))",
       x="Time since carbon inputs removed (yr)",
       color = "Model",
       linetype = "Model"
       ) +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5) ) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) #+
  # #For demo-ing uncertainty in the model
  #geom_ribbon(aes(x=time/12, ymax=C_total*1.1, ymin=C_total*0.9, fill=model), alpha=0.1) +
  #scale_fill_manual(values=c("#FA4616", "#0021A5")) +


```

```{r Exp, eval=FALSE}
ggplot(no_input_model_comparison.sim %>% mutate(dCO2dtfluxPercent = dCO2dt/C_total)) +
  geom_line(aes(x=time/12, y=dCO2dtfluxPercent*100, color=model)) +
  labs(title="Carbon dioxide flux from soil over time", 
       subtitle = "a simulation of an incubation experiment",
       y="CO2 flux, as a percentage of total SOC", 
       x="Time since carbon inputs removed (yr)",
       color = "Model", fill = "Model") +
  theme(
    legend.position = c(0.1, 0.1),
    legend.justification = c("left", "bottom"),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)) +
  scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) 
```


### Fluctuating Inputs

NPP changes on diurnal, seasonal, and even longer-term cycles. When inputs are fluctuating, how does this one-pool proxy respond? We will focus on a yearly seasonal cycle (the parametrizations from Parton are monthly, so this makes sense as a starting point).

```{r InputsFlux}
#Function for simulation with the 3feedback model, adjusting the inputs for seasonal change
dCdt_seasonal_century <- function(t, y, parms, input_type = 'seasonal' ){
  pools <- matrix(y, nrow=3)
  allocation_matrix <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
  
  
  if(input_type == 'seasonal'){
    flux_input <- (5/300)*sin((pi/6)*t+(3*pi/2))+(5/300) #offset by the parms$input parameter
  }else{
    flux_input <- parms$inputs
  }
  
  ans <- flux_input * allocation_matrix - decay_matrix %*% transfer_matrix %*% y
  ##check conservation of mass
  
  return(list(c(C_fast = ans[1],
           C_slow = ans[2],
           C_passive = ans[3]))) #add in CO2 pool
}

#Simulation to verfiy that the method works to create seasonal change, over 5 years
seasonal_century.sim <- lsoda(y = SS_Century(parms = century_parameter.ls),
                                      times = Simtimes, 
                                      func = dCdt_seasonal_century,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>% 
                                  mutate(C_total = C_fast+C_slow+C_passive) %>%
                                  mutate(model= "Century") %>%
                                  mutate(dCO2dt = dCdt_Century(t=NA, 
                                                                 y=c(G=0,C_fast, C_slow, C_passive), 
                                                                 parms= no_input_century_parameter.ls)[[1]]["G"], 
                                                                 .by=everything() 
                                         )


ggplot(data.frame(t=seq(0,(12*3), by=0.2)) %>% mutate(Inputs=(5/300)*sin((pi/6)*t+(3*pi/2))+(5/300)))+
  geom_line(aes(x=t, y=Inputs)) +
  labs(x="Time (months)", y="Carbon inputs")


#Graphical depiction of the change
ggplot(pivot_longer(data=seasonal_century.sim, cols = C_fast:C_passive, names_to = "pool", values_to = "stock")) +
  geom_line(aes(x=time, y=stock, color=pool)) +
  geom_line(aes(x=time, y=C_total, color="Total SOC")) +
  xlim(0,(5*12))+ 
  labs(x="Time (months)", y="kg Organic Carbon / m^2")


#One-Pool rate change function, with seasonal rate of change
  ##The calucation of the Proxy decay rate relies on a steady state solution, which technically does not exist when inputs change and is instead replaced with a semisteady state - we then consider that the average over the year is constant, and that the steady state solution suffices.

dCdt_seasonal_proxy <- function(t, y, parms){
  flux_input <- (5/300)*sin((pi/6)*t+(3*pi/2))+(5/300)
  ans <- flux_input - y / parms$turnoverTime
  return(list(ans))
}


#Simulation to show that the method works to create seasonal change, over 5 years
seasonal_proxy.sim <- lsoda(y = sum(SS_Century(parms = century_parameter.ls)) %>% setNames("C"),
                                      times = Simtimes, 
                                      func = dCdt_seasonal_proxy,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>%
                                  rename(C_total = C) %>%
                                  mutate(model="Proxy") %>%
                                  mutate(dCO2dt = dCdt_1pool(t=NA, 
                                                             y=c(G=0,C_total), 
                                                             parms= no_input_century_parameter.ls)[[1]]["G"], 
                                                            .by=everything() )

# #Graphical Demonstration of the three pools + Total SOC
# ggplot(seasonal_proxy.sim) +
#   geom_line(aes(x=time, y=C_total))+
#   xlim(0,(5*12))+ 
#   labs(x="Time (months)", y="kg Organic Carbon / m^2")+
#   ylim(4.2,4.5)


seasonal_model_comparison.sim <- bind_rows(seasonal_proxy.sim, seasonal_century.sim)



SeasonalGas.plot <- ggplot(seasonal_model_comparison.sim) +
  geom_line(aes(x=time/12, y=dCO2dt*12, color=model, linetype=model)) +
  xlim(0,3) +
  #geom_ribbon(aes(x=time/12, ymax=dCO2dt*1.1*12, ymin=dCO2dt*0.9*12, fill=model), alpha=0.1)+
  # labs(title="Through the Seasons: CO2 flux", 
  #      subtitle = "Inputs fluctuate sinusoidally",
  #      y="CO2 flux (kg C/(m^2 yr))", 
  #      x="Time since carbon inputs removed (yr)",
  #      color = "Model",
  #      fill = "Model"
  #      ) +
  # theme(
  #   legend.position = c(0.05,0.95),
  #   legend.justification = c("left", "top"),
  #   plot.title = element_text(hjust = 0.5),
  #   plot.subtitle = element_text(hjust = 0.5)) +
  # scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) 


SeasonalStocks.plot <- ggplot(seasonal_model_comparison.sim) +
  geom_line(aes(x=time/12, y=C_total, color=model, linetype=model)) +
  #geom_ribbon(aes(x=time/12, ymax=C_total*1.1, ymin=C_total*0.9, fill=model), alpha=0.1)+
  # labs(title="Through the Seasons: Soil Stocks", 
  #      subtitle = "Inputs fluctuate sinusoidally",
  #      y="Total Carbon Stocks (kg C/(m^2 yr))", 
  #      x="Time since carbon inputs removed (yr)",
  #      color = "Model",
  #      fill = "Model",
  #      linetype = "Model"
  #      ) +
  # theme(
  #   legend.position = c(0.05,0.95),
  #   legend.justification = c("left", "top"),
  #   plot.title = element_text(hjust = 0.5),
  #   plot.subtitle = element_text(hjust = 0.5) ) +
  #scale_fill_manual(values=c("#FA4616", "#0021A5")) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  # ylim(4.35,4.425)+
   xlim(0,3) 


                                
# #Makes a dataframe to compare the two simulations total carbon
# seasonal_model_comparison <- as.data.frame(cbind(seasonal_sim_3feedback$time, seasonal_sim_3feedback$Feedback_C_total, seasonal_sim_proxy$One_Pool_Proxy)) %>% 
#     set_names(c("time", "Feedback_C_Total", "One_Pool_Proxy")) %>%
#     pivot_longer(cols = c("Feedback_C_Total", "One_Pool_Proxy"),
#                                  names_to = "model",
#                                  values_to = "stock")

ggplot(seasonal_model_comparison.sim %>% 
         select(time, model, C_total) %>%
         pivot_wider(names_from = "model", values_from = "C_total"))  +
  geom_point(aes(x=Proxy, y=Century)) +
  geom_abline()+
  labs(title="Model Comparison for Seasonal Changes", subtitle = "Values from 100-year simulation, taken monthly")



```

Now to put it all together:

```{r MainFig}

#Normalize the ranges
CO2range <- c(min(seasonal_model_comparison.sim$dCO2dt,no_input_model_comparison.sim$dCO2dt), max(seasonal_model_comparison.sim$dCO2dt,no_input_model_comparison.sim$dCO2dt))
Stocksrange <- c(min(seasonal_model_comparison.sim$C_total,no_input_model_comparison.sim$C_total), max(seasonal_model_comparison.sim$C_total,no_input_model_comparison.sim$C_total))

#futzing with linetype
LT <- c(2,4)

SeasonalGas.plot  <- SeasonalGas.plot +
    ylim(CO2range*12) +
    labs(x = "Time (yr)", y="CO2 flux (kg C/(m^2 yr))", 
         #caption = "Seasonal CO2 flux", 
         color = "Model", linetype = "Model")+
    scale_linetype_manual(values=LT) +
    scale_y_continuous(position = "right") +
    theme(axis.title.x = element_text(family="Helvetica", size = 42))+
    theme(axis.title.y.right = element_text(family="Helvetica", size = 42)) +
    #theme(plot.caption = element_text(family = "Helvetica", hjust=0, size=rel(1.2))) +
    theme_light()


SeasonalStocks.plot <- SeasonalStocks.plot +
    ylim(Stocksrange) +
    labs(x="Time (yr)", y="Total SOC (kg/(m^2 yr))", 
         #title= "Seasonal S.O.C.", 
         color = "Model", linetype = "Model")+
    scale_linetype_manual(values=LT) +
    scale_y_continuous(position = "right")+
    scale_x_continuous(position = "top")+
    #theme(plot.title = element_text(family="Times New Roman", hjust=0.5))+
    theme_light()

 
IncubationGas.plot <- IncubationGas.plot +
    ylim(CO2range*12) +
    labs(x = "Time (yr)", y="CO2 flux (kg C/(m^2 yr))", 
         #caption= "Incubation CO2 flux", 
         color = "Model", linetype = "Model")+
    scale_linetype_manual(values=LT) +
    #theme(plot.caption = element_text(hjust=0.5, size=rel(1.2)))+
    theme_light()


IncubationStocks.plot <- IncubationStocks.plot +
    ylim(Stocksrange) +
    labs(x="Time (yr)", y="Total SOC (kg/(m^2 yr))", 
         #title= "Incubation S.O.C.", 
         color = "Model", linetype = "Model")+
    scale_linetype_manual(values=LT) +
    scale_x_continuous(position = "top") +
    #theme(plot.title = element_text(hjust=0.5)) +
    theme_light()


my_layout <- c(area(2,  2, 50, 50),  #area(top,left,bottom,right)
               area(1, 51, 50,100),
               area(51, 1,100, 50),
               area(51,51, 99, 99))


IncubationStocks.plot + SeasonalStocks.plot + IncubationGas.plot + SeasonalGas.plot + 
    plot_layout(design = my_layout,
                guides = 'collect')





```

```{r MiniFig}


MC_Season_SOC.plot <- ggplot(seasonal_model_comparison.sim %>% 
         select(time, model, C_total) %>%
         pivot_wider(names_from = "model", values_from = "C_total"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Seasonal Changes, S.O.C.") +
  xlim(min(seasonal_model_comparison.sim$C_total), max(seasonal_model_comparison.sim$C_total)) +
  ylim(min(seasonal_model_comparison.sim$C_total), max(seasonal_model_comparison.sim$C_total))


MC_Season_CO2.plot <- ggplot(seasonal_model_comparison.sim %>% 
         select(time, model, dCO2dt) %>%
         pivot_wider(names_from = "model", values_from = "dCO2dt"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Seasonal Changes, CO2 flux") +
  xlim(min(seasonal_model_comparison.sim$dCO2dt), max(seasonal_model_comparison.sim$dCO2dt)) +
  ylim(min(seasonal_model_comparison.sim$dCO2dt), max(seasonal_model_comparison.sim$dCO2dt))

MC_Inc_CO2.plot <- ggplot(no_input_model_comparison.sim %>% 
         select(time, model, dCO2dt) %>%
         pivot_wider(names_from = "model", values_from = "dCO2dt"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Incubation experiment, CO2 flux")+
  xlim(min(no_input_model_comparison.sim$dCO2dt), max(no_input_model_comparison.sim$dCO2dt)) +
  ylim(min(no_input_model_comparison.sim$dCO2dt), max(no_input_model_comparison.sim$dCO2dt))

MC_Inc_SOC.plot <- ggplot(no_input_model_comparison.sim %>% 
         select(time, model, C_total) %>%
         pivot_wider(names_from = "model", values_from = "C_total"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Incubation experiment, S.O.C.")+
  xlim(min(no_input_model_comparison.sim$C_total), max(no_input_model_comparison.sim$C_total)) +
  ylim(min(no_input_model_comparison.sim$C_total), max(no_input_model_comparison.sim$C_total))

MC_Inc_SOC.plot + MC_Season_SOC.plot + MC_Inc_CO2.plot + MC_Season_CO2.plot + 
    plot_annotation(title = 'Model Comparisons') +
    plot_layout(design = my_layout,
                guides = 'collect')

```


```{r MainFig2}
no_input_model_comparison.sim <- no_input_model_comparison.sim %>% mutate(Simulation = "Incubation")
seasonal_model_comparison.sim <- seasonal_model_comparison.sim %>% mutate(Simulation = "Seasonal")

Model_Comparison_all.sim <- bind_rows(seasonal_model_comparison.sim, no_input_model_comparison.sim)

LT <- c(2,1)

CompGas.plot <- ggplot(Model_Comparison_all.sim) +
  geom_line(aes(x=time/12, y=dCO2dt*12, linetype=model, color=Simulation)) +
  labs(y="CO2 flux (kg C/(m^2 yr))", 
        x="Time (yr)"
        ) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  scale_linetype_manual(values=LT) 

CompSOC.plot <- ggplot(Model_Comparison_all.sim) +
  geom_line(aes(x=time/12, y=C_total, 
                  linetype=Simulation, 
                  color=model), alpha=0.8) +
  labs(y="Total S.O.C. (kg C/m^2 )", 
        x="Time (yr)"
        ) +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  scale_linetype_manual(values=LT) 

CompSOC.plot + inset_element(SeasonalStocks.plot, left =  unit(1, 'npc') - unit(1, 'cm'), bottom =  unit(1, 'npc') - unit(1, 'cm'), right =0.5, top = 0.5) # / CompGas.plot

```

##Other simulations:
###Regime Transition

```{r}
century_parameter.ls <- c(century_parameter.ls,
                          Regime_Change_ratio = 2,
                          Regime_Change_duration = Inf, #in years
                          Start_Regime_Change = 20 #in years
                          )

Simtimes <- seq(0,(500*12), 6)

#Rate of Change for the Regime Change simulation
dCdt_regime_century <- function(t, 
                                y, #y is a vector in the order of: (C_fast, C_slow, C_passive, Inputs, G)
                                parms){
  pools <- matrix(y[1:3], nrow=3)
  allocation_matrix <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
  
#Changing the inputs for X years; we'll see if this works with lsoda (it does!)
#Change the duration of input change, time at which the change occurs, and ratio of input change in the parameter list at the top of the chunk
  if(t >= parms$Start_Regime_Change*12 &
     t < (12*(parms$Start_Regime_Change+parms$Regime_Change_duration)) ){
    RegimeInputs <- parms$inputs*parms$Regime_Change_ratio
  } else { 
    RegimeInputs <- parms$inputs 
  }
  
  ans <- RegimeInputs * allocation_matrix - decay_matrix %*% transfer_matrix %*% pools
  
  dCO2 <- sum(decay_matrix %*% transfer_matrix %*% pools)
  
  return(list(c(C_fast = ans[1],
           C_slow = ans[2],
           C_passive = ans[3],
           Inputs = RegimeInputs,
           G = dCO2
           ))) 
}

#Rate of Change for the proxy function
dCdt_regime_proxy <- function(t, y, parms){
  
  pool <- y[1]
  
#Changing the inputs for X years; we'll see if this works with lsoda
  if(t >= parms$Start_Regime_Change*12 &
     t < (12*(parms$Start_Regime_Change+parms$Regime_Change_duration)) ){
    RegimeInputs <- parms$inputs*parms$Regime_Change_ratio
  } else { 
    RegimeInputs <- parms$inputs 
  }
  
  ans <- RegimeInputs - pool / parms$turnoverTime
  
  dCO2 <- pool / parms$turnoverTime
  
  return(list(c(ans, Inputs = RegimeInputs, G = dCO2)))
}


regime_change_feedback_sim <- lsoda(y = c(SS_Century(parms = century_parameter.ls), Inputs = 0, G=0),
                                      times = Simtimes,
                                      func = dCdt_regime_century,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(C_total = C_fast + C_slow +C_passive) %>%
                          mutate(model="Century") %>%
                          mutate(dCO2dt = dCdt_Century(t=NA, 
                                                         y=c(G=0,C_fast, C_slow, C_passive), 
                                                         parms=century_parameter.ls)[[1]]["G"], 
                                .by=everything() 
                                )

ggplot(regime_change_feedback_sim, aes(x=time)) +
  geom_area(aes(y=Inputs), color="red", alpha=0.1) +
  geom_area(aes(y=G), color="blue", alpha=0.1)

regime_change_proxy_sim <- lsoda(y = c(C_total=sum(SS_Century(parms = century_parameter.ls)), Inputs=0, G=0),
                                      times = Simtimes,
                                      func = dCdt_regime_proxy,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(model="Proxy") %>%
                          mutate(dCO2dt = dCdt_1pool(t=NA, 
                                                     y=c(C_total,Inputs, G), 
                                                     parms=century_parameter.ls)[[1]]["G"], 
                                 .by=everything() )

ggplot(regime_change_proxy_sim, aes(x=time)) +
  geom_area(aes(y=Inputs), color="red", alpha=0.1)+
  geom_area(aes(y=G), color="blue", alpha=0.1)


regime_change_model_comparison.sim <- bind_rows(regime_change_feedback_sim, regime_change_proxy_sim)

ggplot(regime_change_model_comparison.sim) + 
  #geom_rect(aes(xmin=6/12, xmax=18/12, ymin=-Inf, ymax=Inf), color="lightgrey", alpha=0.1) +
  geom_vline(xintercept=century_parameter.ls$Start_Regime_Change, linetype="dashed", alpha=0.5, color="black") +
  #geom_vline(xintercept=century_parameter.ls$Start_Regime_Change/12 + century_parameter.ls$Regime_Change_duration, linetype="dashed", alpha=0.5, color="black")  +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  geom_line(aes(x=time/12, y=C_total, color=model)) +
  labs(title="Regime Change over time, S.O.C. stocks") 


ggplot(regime_change_model_comparison.sim) + 
  #geom_rect(aes(xmin=6/12, xmax=18/12, ymin=-Inf, ymax=Inf), color="lightgrey", alpha=0.1) +
  geom_vline(xintercept=6/12, linetype="dashed", alpha=0.5, color="black") +
  geom_vline(xintercept=18/12, linetype="dashed", alpha=0.5, color="black")  +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  geom_line(aes(x=time/12, y=dCO2dt*12, color=model)) +
  labs(title="Regime Change over time, Respiration")


ggplot(regime_change_model_comparison.sim %>% 
         select(time, model, C_total) %>%
         pivot_wider(names_from = "model", values_from = "C_total"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Regime Change, S.O.C.") +
  xlim(min(regime_change_model_comparison.sim$C_total), max(regime_change_model_comparison.sim$C_total)) +
  ylim(min(regime_change_model_comparison.sim$C_total), max(regime_change_model_comparison.sim$C_total))


```


###Detrital Treatments Transition

```{r}
century_parameter.ls <- c(century_parameter.ls,
                          Detritus_addition = 0.1, #percentage of soc added
                          Detritus_time = 0 #in months
                          )

Simtimes <- seq(0,(20*12), 1)

#Rate of Change for the Detritus addition simulation
dCdt_detrital_addition_century <- function(t, 
                                y, #y is a vector in the order of: (C_fast, C_slow, C_passive, G)
                                parms){
  pools <- matrix(y[1:3], nrow=3)
  allocation_matrix <- matrix(c(parms$input_to_fast, 
                                parms$input_to_slow, 
                                1 - parms$input_to_fast - parms$input_to_slow),
                              nrow = 3)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_fast,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(1,  -parms$slow_to_fast, -parms$passive_to_fast,
                              -parms$fast_to_slow, 1, -parms$passive_to_slow,
                              -parms$fast_to_passive, -parms$slow_to_passive,  1),
                            nrow = 3,
                            byrow=TRUE)
  
#Change the percentage of addition and time at which the change occurs in the parameter list at the top of the chunk
  if(t == parms$Detritus_time ){
    pools <- pools + parms$Detritus_addition*sum(pools)*allocation_matrix
  } 
  
  ans <-parms$inputs * allocation_matrix - decay_matrix %*% transfer_matrix %*% pools
  
  dCO2 <- sum(decay_matrix %*% transfer_matrix %*% pools)
  
  return(list(c(C_fast = ans[1],
           C_slow = ans[2],
           C_passive = ans[3],
           G = dCO2
           ))) 
}

#Rate of Change for the proxy function
dCdt_detrital_addition_proxy <- function(t, y, parms){
  
  pool <- y[1]
  
#Change the percentage of addition and time at which the change occurs in the parameter list at the top of the chunk
  if(t == parms$Detritus_time ){
    pool <- pool + parms$Detritus_addition*pool
  } 
  
  ans <- parms$inputs - pool / parms$turnoverTime
  
  dCO2 <- pool / parms$turnoverTime
  
  return(list(c(ans, G = dCO2)))
}


detrital_addition_feedback_sim <- lsoda(y = c(SS_Century(parms = century_parameter.ls), G=0),
                                      times = Simtimes,
                                      func = dCdt_detrital_addition_century,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(C_total = C_fast + C_slow +C_passive) %>%
                          mutate(model="Century") %>%
                          mutate(dCO2dt = dCdt_Century(t=NA, 
                                                         y=c(G=0,C_fast, C_slow, C_passive), 
                                                         parms=century_parameter.ls)[[1]]["G"], 
                                .by=everything() 
                                )

ggplot(detrital_addition_feedback_sim, aes(x=time)) +
  geom_area(aes(y=G), color="blue", alpha=0.1)

detrital_addition_proxy_sim <- lsoda(y = c(C_total=sum(SS_Century(parms = century_parameter.ls)), G=0),
                                      times = Simtimes,
                                      func = dCdt_detrital_addition_proxy,
                                      parms = century_parameter.ls) %>%
                                  as.data.frame() %>%
                          mutate(model="Proxy") %>%
                          mutate(dCO2dt = dCdt_1pool(t=NA, 
                                                     y=c(C_total, G), 
                                                     parms=century_parameter.ls)[[1]]["G"], 
                                 .by=everything() )

ggplot(detrital_addition_proxy_sim, aes(x=time)) +
  geom_area(aes(y=G), color="blue", alpha=0.1)


detrital_addition_model_comparison.sim <- bind_rows(detrital_addition_feedback_sim, detrital_addition_proxy_sim)

ggplot(detrital_addition_model_comparison.sim) + 
  geom_vline(xintercept=century_parameter.ls$Detritus_time, linetype="dashed", alpha=0.5, color="black") +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  geom_line(aes(x=time/12, y=C_total, color=model)) +
  labs(title="Sim Change over time, S.O.C. stocks") 


ggplot(detrital_addition_model_comparison.sim) + 
  geom_vline(xintercept=century_parameter.ls$Detritus_time, linetype="dashed", alpha=0.5, color="black") +
  scale_color_manual(values=c("#FA4616", "#0021A5")) +
  geom_line(aes(x=time/12, y=dCO2dt*12, color=model)) +
  labs(title="Sim Change over time, Respiration")


ggplot(detrital_addition_model_comparison.sim %>% 
         select(time, model, C_total) %>%
         pivot_wider(names_from = "model", values_from = "C_total"))  +
  geom_abline(color='red') +
  geom_point(aes(x=Proxy, y=Century)) +
  labs(title="Sim Change, S.O.C.") +
  xlim(min(regime_change_model_comparison.sim$C_total), max(regime_change_model_comparison.sim$C_total)) +
  ylim(min(regime_change_model_comparison.sim$C_total), max(regime_change_model_comparison.sim$C_total))


```




##Adding the litter: Five decay pools

Century uses two litter pools (structural and metabolic, based on lignin ratio) in addition to the three soil pools (fast (active), slow, and passive speeds of decay). 

```{r Five pool model}
century_parameter5.ls <- list(
                    inputs = 0.2/12, #monthly; divided evenly between the months
                      input_to_struc = .125,  
                      input_to_meta = .875,  
                      #no direct inputs into soil pools; C goes through litter pools first
                        input_to_fast = 0,  
                        input_to_slow = 0,  
                        input_to_passive = 0,  
                            
                     #turnover times
                     turnoverTime_meta = .5*12,   #.5y
                     turnoverTime_fast = 1.5*12,    #1.5y
                     turnoverTime_struc = 3*12,    #3y
                     turnoverTime_slow = 25*12,       #25y
                     turnoverTime_passive = 1000*12,  #1000y
                     
                       struc_to_fast = varying_century_params$lignin_frac*.5, 
                          #lignin fraction determines split between slow and fast, then 50% respired
                       struc_to_slow = varying_century_params$lignin_frac*.7, 
                          #lignin fraction determines split between slow and fast, then 30% respired
                       meta_to_fast = .45,    #55% as CO2
                       fast_to_slow = 1-(0.85-(0.68*varying_century_params$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                      #all the zero-flows to/from litter pools:
                        meta_to_struc = 0,
                        meta_to_slow = 0,
                        meta_to_passive = 0,
                        struc_to_meta = 0,
                        struc_to_passive = 0,
                        fast_to_meta = 0,
                        slow_to_meta = 0,
                        passive_to_meta = 0,
                        fast_to_struc = 0,
                        slow_to_struc = 0,
                        passive_to_struc = 0,
                        
                        
                    #all soil flows
                       fast_to_slow = 1-(0.85-(0.68*varying_century_params$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                       fast_to_passive = 0.004,    
                       slow_to_fast = 0.42,        
                       slow_to_passive = 0.03,     
                       passive_to_fast = 0.45,     
                       passive_to_slow = 0         # CENTURY does not include this flow
                       )

#steady state calculations for each pool
SS_Century5 <- function(parms){
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,    -parms$slow_to_fast,    -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  ans <- solve(decay_matrix  %*% transfer_matrix ,parms$inputs * allocation_vector)

  return(c(Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]))
}


#ODE for a five-pool FOLD model
dCdt_Century5 <- function(t, y, parms){
  G <- y[1]
  pools <- matrix(y[2:6], nrow=5)
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5
                              )
  
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive
                             )
                       )
  
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,     -parms$slow_to_fast,   -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  ans <- parms$inputs * allocation_vector - decay_matrix %*% transfer_matrix %*% pools
  
  resp <- decay_matrix %*% transfer_matrix %*% pools
  total_resp <- sum(resp)
  
  return(list(c(
           G = total_resp,
           Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]
           )
           )
         )
}


#making a more realistic simulation time for a monthly model with turnover times in the 1000s
simTime <- 1000*12

#simulation
sim_Century5 <- lsoda(y = c(G=0, 
                            SS_Century5(parms = century_parameter5.ls)*0.75),
                      times = 0:simTime,
                      func = dCdt_Century5,
                      parms = century_parameter5.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) 


#Feedback graph by pools:
ggplot(sim_Century5 %>%
         pivot_longer(cols = Lit_metabolic:Soil_passive,
                      names_to = 'pool',
                      values_to = 'stock')%>%
         mutate(pool = factor(pool, levels = c('Lit_metabolic', 'Lit_structural', 'Soil_fast', 'Soil_slow', 'Soil_passive')),
                model = '5pool')
) +
  geom_line(aes(x=time, y=stock)) +
  facet_wrap(~ pool, ncol=1, scales='free')


#Feedback graphs: total carbon and respiration 
ggplot(sim_Century5 %>%
         pivot_longer(cols = Lit_metabolic:Soil_passive,
                      names_to = 'pool',
                      values_to = 'stock')%>%
         mutate(pool = factor(pool, levels = c('Lit_metabolic', 'Lit_structural', 'Soil_fast', 'Soil_slow', 'Soil_passive')),
                model = '5 pool')
) +
  geom_line(aes(x=time, y=stock)) +
  facet_wrap(~ pool, ncol=1, scales='free') + 
  scale_x_log10()


```

