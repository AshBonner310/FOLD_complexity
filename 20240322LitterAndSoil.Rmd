---
title: "Litter and soil pools"
author: "Ashley Bonner"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
#useful functions in here

library(tidyverse) #data library
library(deSolve) #ODE solver
library(patchwork) #figure arrangement
library(DiagrammeR) #flow charts
library(dplyr) #data wrangling

knitr::opts_chunk$set(echo = TRUE)
```


# A standard one pool model

The rate of change of soil carbon stocks is the balance between the inputs and the outputs because of conservation of mass -- carbon is neither created nor distroyed.
In this simple one pool model we assume a constant input rate ($u$; [mass per area per time]).
The outputs are assumed to be proportional to the stock that is there.
There are other functional forms that could also use but this is the simplest (and also happens to fit incubation experiments).

$\frac{dC}{dt} = u - kC$

where 

  + $C$ is the carbon stock [mass per area]. This is often on the order of 1 to 150 kg-organic-carbon m^-2^ for the first meter of soil (HWSD2)
  + $u$ is the inputs into the soil [mass per area per time]. Between root exodase, root turnover, and surface litter, inputs are difficult to quantify directly. However net primary productivity is often used as a proxy for soil inputs and varies between 0 to 2.5 kg-organic-carbon m^-2^ yr^-1^ with the geographic mode occurring around 0.2 kg-C m^-2^ yr^-1 (MODIS - MOD17A3)
  + $k$ is the decay rate is the fraction of carbon leaving the soil carbon pool per time. This is often framed as it's inverse, turnover time ($k=\frac{1}{\tau}$) which has many interpretation but for this model is the average length of time a carbon atom will spend in the soil. The bulk turnover time in Earth system models is on the order of 10 to 50 years (CMIP5 and CMIP6).
  
From this model we can calculate the steady state value, where the rate of change is zero.
This describes the carbon stock that the system is trending towards as it matures.

$C_{ss} = \frac{u}{k} = u k^{-1} = u\tau$

This also gives us a useful check on our ranges if we assume that soil carbon stocks are generally close to steady state. 
$u\tau = [0, 0.2, 2.5] [10, 15, 50] = [0, 3, 125]$

It's very very close to the stated ranges for the soil carbon stocks of $[1,150] \frac{kg-C}{m^2 yr^1}$.

We can also look at the inputs and carbon stocks to infer the turnover times.
$\frac{C}{u} \left( \frac{kgC/m^2}{kgC/m^2yr }\right)= \frac{[1, 150]}{[0.1, 2.5]} = [0.4, 1500] \left( yr \right)$
which is a MUCH larger range of turnover times.
So this would be consistent with the observations but maybe not constraining of the parameters.

```{r OnePool}
Parameters_OnePool.ls <- list(inputs = 0.2/12, 
                                #u; [0, 2.5] kg-carbon m-2 yr-1; split per month (to fit CENTURY parameters)
                              turnoverTime = 15*12,
                                #\tau; [10, 50] yr, by month
                              input_type = 'base' 
                                #more on the input type later - the base form assumes constant inputs
                             ) 
OnePoolSimTime <- 100*12

#rate of change function
dCdt_OnePool.fn <- function(t, y, parms, rel_tol = 1e-8){ #
  y <- unname(y)
  CO2 <- y[1] 
  soil <- y[2]
  
  if(! all(c('input_type', 'turnoverTime', 'inputs') %in% names(parms))){
    stop('You have a parameter missing that this function needs.')
  }
  
  if(parms$input_type != 'base'){
    u <- InputType.fn(parms = parms,
                      timepoint = t)
  }else{
    u <- parms$inputs
  }
  
  dCO2 <- soil / parms$turnoverTime
  dSoil <- u - soil / parms$turnoverTime

  #if we're not doing a zero-input run...
  if(u != 0){ 
    
    # print(paste("dC02", dCO2))
    # print(paste("dSoil", dSoil))
    # print(paste("Relative Tolerance", rel_tol))
    
    #make a relative tolerance to ensure conservation of mass
    if(abs(u - (dCO2 + dSoil))/u > rel_tol){ 
      #relative tolerance allowance
        stop('Conservation of mass does not hold')
    }
  }
  return(list(c(Cummulative_Respiration = dCO2, C_total = dSoil)))
}

#steady state function
SS_OnePool.fn <- function(parms){
    ans <- parms$inputs * parms$turnoverTime
  return(c(Cummulative_Respiration = 0, C = ans))
}


ggplot(lsoda(y = SS_OnePool.fn(parms=Parameters_OnePool.ls)*0.7,
                times = seq(0, OnePoolSimTime, by = 1/10),
                func = dCdt_OnePool.fn,
                parms = Parameters_OnePool.ls) %>%
          as.data.frame()
       ) + 
  geom_line(aes(x=time, y=C)) +
  geom_line(data = lsoda(y = SS_OnePool.fn(Parameters_OnePool.ls),
                times = seq(0, OnePoolSimTime, by = 1/10),
                func = dCdt_OnePool.fn,
                parms = Parameters_OnePool.ls) %>%
          as.data.frame(), aes(x=time, y=C), linetype="dotted")




```

Tracking carbon stocks in soil is important to understanding how much carbon could be sequestered, and helps to answer questions around whether soil could serve as a carbon sink or as a source across diverse ecosystems as our climate changes.
Another important metric we will be considering is how much CO$_2$ is respired over a certain period of time.
This largely depends on where the model starts, but discussing the basics here seems pertinent.

# The Century Soil Carbon model - 5 pools

William Parton's Century model was developed in 1988 to describe soil organic matter dynamics and became the base form for SOM modeling in global models today. 

```{r Diagram, echo = FALSE}
grViz("
  digraph Three_Pool_Model {
    rankdir=LR
    
    subgraph outside_the_system{ 
    node[ shape = oval,
          font = Baskerville,
          style=dashed]
    Inputs[label = 'Vegetation']; CarbonDioxide
    }
    
    Inputs  -> Metabolic     [headport=w, color = goldenrod]; 
    Inputs  -> Structural    [headport=w, color = green3]; 
    Fast    -> CarbonDioxide [tailport=s, color = red3]; 
    Slow    -> CarbonDioxide [tailport=s, color=purple3]; 
    Passive -> CarbonDioxide [tailport=s, color=blue3]
    
    Metabolic  -> Fast          [color = goldenrod, tailport = e]
    Metabolic -> CarbonDioxide  [color = goldenrod, tailport = e]
    Structural -> Fast          [color = green3, tailport = e]
    Structural -> Slow          [color = green3, tailport = e]
    Structural -> CarbonDioxide [color = green3, tailport = e]
    
    subgraph Pools{
    
    
      subgraph cluster_LitterPools{
        label = 'Litter Pools'
        
        node[ shape = oval,
              font = Baskerville,
              style = solid]
          rank=same
          
        Metabolic[color=goldenrod, fontcolor=darkgoldenrod]; Structural[color=green3, fontcolor=green4]
              
      }
    
      subgraph cluster_SoilPools {
        label = 'Soil Pools'
    
        node[ shape = oval,
              font = Baskerville,
              style = solid]
        rank = same
          
        Fast[color=red3, fontcolor=red4]; Slow[color=purple3, fontcolor=purple4]; Passive[color=blue3, fontcolor=blue4]
        
        #Fluxes out of Fast
        Fast -> Slow[tailport=s, color = MediumVioletRed]
        Fast -> Passive[tailport=s, color = DarkViolet]
        
        #Fluxes out of Slow
        Fast -> Slow [dir=back, color = MediumVioletRed, headport = s]
        Slow -> Passive[tailport=s, color = SlateBlue3]
        
        #Fluxes out of Passive
        Fast -> Passive[dir=back, color=DarkViolet, headport = s]
        #Slow -> Passive[dir=back, color=SlateBlue3, headport = n]
      }
    }
    }
  }
")

```

This diagram comes in the form of the matrix ordinary differential equation

$$\frac{d\vec{C}}{dt} = u \vec{b} - \boldsymbol{K}\boldsymbol{A}\vec{C} $$
where:
 - $\vec{C}$ is a vector representing the five pools (state variables) in the order from the fastest decay rate to the slowest (more on that later), 
 - $u$ is the inputs to the system (often estimated as a fraction of vegetation's net primary production),
 - $\vec{b}$ is a vector that divides up the carbon inputs into the soil system (in Century, this is all into the litter pools)
 - $\boldsymbol{K}$ is a diagonal matrix with the decay rates of the pools,
 - $\boldsymbol{A}$ is called the transfer matrix and can be of three different types [diagonal (for a model where the pools are independant and have no fluxes betwen them), lower-triangular (for a cascade model, where carbon flows from simpler forms to more complex forms due to the ecological principal of trophic cascades), or fully dense (for a model that allows carbon to move freely between the pools)]. In any of these three cases, the diagonal entries are all positive one, and the off-diagonal entries are nonpositive (negative or zero), and the columns will always sum to a positive value less than one. 


```{r FivePoolParameters}

#Calculating Variable Century model parameters
Varying_Century_Parameters.ls <- list(
  SMsplit =  1/8,
    #fraction of plant residue that is structural rather than metabolic
  lignin_frac = .5,
    #using a placeholder here, still uncertain.
  silt_clay_frac = .4 + .2
    #based on an "ideal" silt and clay fraction
)


Parameters_FivePool.ls <- list(
                  ##Input-based parameters (such as allocation)
                  input_type = 'base', 
                        #options: constant, seasonal, incubation, regime shift
                  inputs = 0.2/12, 
                        #monthly; divided evenly between the months
                    input_to_struc = Varying_Century_Parameters.ls$SMsplit,  
                    input_to_meta = 1-Varying_Century_Parameters.ls$SMsplit,  
                        #no direct inputs into soil pools; C goes through litter pools first
                    input_to_fast = 0,  
                    input_to_slow = 0,  
                    input_to_passive = 0,  
                            
                  ##turnover times
                     turnoverTime_meta = .5*12,  
                        #.5 years
                     turnoverTime_fast = 1.5*12,   
                        #1.5 years
                     turnoverTime_struc = 3*12,    
                        #3 years
                     turnoverTime_slow = 25*12,       
                        #25 years
                     turnoverTime_passive = 1000*12,  
                        #1000 years
                     
                  ##Transfer Matrix values 
                    #Values reliant on other parts of the CENTURY model (nitrogen, etc.) or specific to certain soils (silt/clay/sand fraction)
                       struc_to_fast = Varying_Century_Parameters.ls$lignin_frac*.5, 
                          #lignin fraction determines split between slow and fast, then 50% respired
                       struc_to_slow = Varying_Century_Parameters.ls$lignin_frac*.7, 
                          #lignin fraction determines split between slow and fast, then 30% respired
                       meta_to_fast = .45,    
                          #55% as CO2
                       fast_to_slow = 1-(0.85-(0.68*Varying_Century_Parameters.ls$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                      
                      #all the zero-flows to/from litter pools:
                        meta_to_struc = 0,
                        meta_to_slow = 0,
                        meta_to_passive = 0,
                        struc_to_meta = 0,
                        struc_to_passive = 0,
                        fast_to_meta = 0,
                        slow_to_meta = 0,
                        passive_to_meta = 0,
                        fast_to_struc = 0,
                        slow_to_struc = 0,     
                        passive_to_slow = 0,
                        passive_to_struc = 0,
                        
                    #all other soil flows
                       fast_to_slow = 1-(0.85-(0.68*Varying_Century_Parameters.ls$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                       fast_to_passive = 0.004,    
                       slow_to_fast = 0.42,        
                       slow_to_passive = 0.03,     
                       passive_to_fast = 0.45
                       )

```

```{r FivePoolSimulation}

#steady state calculations for each pool, assuming constant (or averaged over time) inputs
SS_FivePool.fn <- function(parms){
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,    -parms$slow_to_fast,    -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  ans <- solve(decay_matrix  %*% transfer_matrix, parms$inputs * allocation_vector)

  return(c(Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]))
}


#ODE for a five-pool FOLD model
dCdt_FivePool.fn <- function(t, #vector of times
                             y, #6-valued vector in the order of Cummulative Respiration, then pools in ascending order based on turnover time (descending based on decay rate - faster-decaying pools first, so Litter-Metabolic, Soil-Fast, Litter-Structural, Soil-Slow, Soil-Passive)
                             parms, #Parameter list conatining input_type, inputs (monthly average), all allocation of inputs into pools, and all transfer rates between the pools.
                             rel_tol=1e-8 #our default relative tolerance
                             ){ 

  pools <- matrix(y[2:6], nrow=5)
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5
                              )
  
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive
                             )
                       )
  
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,     -parms$slow_to_fast,   -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  # #Debugging code below
  # parms <- list(input_type = 'regimeshift',
  #               inputs = 1,
  #               shift_percent = 2)
  # t <- 11  #seq(0,24, by = 1)
  
  
  if(! all(c('input_type', 'inputs', 'input_to_struc', 'input_to_meta', 'input_to_fast', 'input_to_slow', 'input_to_passive', 'turnoverTime_meta', 'turnoverTime_fast', 'turnoverTime_struc', 'turnoverTime_slow', 'turnoverTime_passive','struc_to_fast', 'struc_to_slow', 'meta_to_fast', 'fast_to_slow', 'meta_to_struc', 'meta_to_slow', 'meta_to_passive', 'struc_to_meta', 'struc_to_passive', 'fast_to_meta', 'slow_to_meta', 'passive_to_meta', 'fast_to_struc', 'slow_to_struc', 'passive_to_struc', 'fast_to_slow', 'fast_to_passive', 'slow_to_fast', 'slow_to_passive', 'passive_to_fast', 'passive_to_slow' ) %in% names(parms))){
    stop('You have a parameter missing that this function needs.')
  }
  
  if(parms$input_type == 'base'){
      #print('^')
      u <- parms$inputs
  }else{
      u <- InputType.fn(parms = parms,
                        timepoint = t)
  }

  ans <- u * allocation_vector - decay_matrix %*% transfer_matrix %*% pools
  
  resp <- decay_matrix %*% transfer_matrix %*% pools
  total_resp <- sum(resp)
  
  #if we're not doing a zero-input run...
  if(u != 0){ 
    #check against a relative tolerance to ensure conservation of mass
    if(abs(u - (total_resp + sum(ans)))/u > rel_tol){ 
      #relative tolerance allowance
        stop('Conservation of mass does not hold')
    }
  }
  
  return(list(c(
           Cummulative_Respiration = total_resp,
           Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]
           )
           )
         )
}


#making a more realistic simulation time for a monthly model with turnover times in the 1000s
  #3000 years (or 3000*12 = 36,000 months), taken at a monthly timestep for the first 10 years, then at a yearly (12 months) timestep
FivePoolSimTime <- c(seq(0,(10*12), by = 0.5), seq((10*12)+1, 2000*12, by=12))

#simulation at partial steady state
SpinUp_FivePool_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)*0.8),
                      times = FivePoolSimTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) %>%
                  mutate(RespirationRate = dCdt_FivePool.fn(t = time, 
                                                            y = c(NA, Lit_metabolic, Soil_fast, Lit_structural, Soil_slow, Soil_passive),
                                                            parms = Parameters_FivePool.ls
                                                            )[[1]]['Cummulative_Respiration'],
                          .by = everything())


#simulation at steady state
SS_FivePool_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)),
                      times = FivePoolSimTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) 

#creates a dataframe to graph both the steady state line and the spinup
Spinup_FivePool_graph.df <- full_join(SpinUp_FivePool_sim.df %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Spinup"), 
                             SS_FivePool_sim.df  %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Steady State")
                             ) %>%
  select(time, pool, stock, sim)

#Setting the Factor allows the pools to show up in the 'right' order
Spinup_FivePool_graph.df$pool <- factor(Spinup_FivePool_graph.df$pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive"))



#Graph by pools:
ggplot(Spinup_FivePool_graph.df) +
  geom_line(aes(x=time/12, y=stock, linetype=sim)) +
  facet_wrap(~ pool, ncol=1, scales='free') +   
  #scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw()

#Stacked graph
ggplot(Spinup_FivePool_graph.df %>%
        filter(sim == 'Spinup')) +
  geom_area(aes(x=time/12, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") +
  scale_x_log10() 

#Respiration Rate test graph:
ggplot(SpinUp_FivePool_sim.df) +
  geom_line(aes(x=time/12, y=RespirationRate)) +
  scale_x_log10()
```

# An Aggregate Decay Rate

## Introduction

Through some mathematical theory, we can actually show that the product of the transfer and decay matrix ($\boldsymbol{KA}$) is an invertible matrix. 
This means that the equation can be solved for steady state, and the form this takes is:
$$ \vec{C}(t) = u \left(\boldsymbol{KA}\right)^{-1} \vec{b} $$
And if we sum up the pools, this actually gives us a single value for the steady state of total soil carbon in the model.
$$ \boldsymbol{C} = u \sum \left( \left( \boldsymbol{KA}\right)^{-1} \vec{b} \right) $$
Recall from the one pool model that the steady state was the carbon inputs ($u$) times the decay rate - allowing us to ask the question: can we consider $\sum \left( \left( \boldsymbol{KA}\right)^{-1} \vec{b} \right)$ to be a proxy decay rate for a more complicated first-oder linear decay model, thus allowing us to use a simpler one-pool model implimentation instead?

We start by calculating what this aggregrate decay rate would be for the Century parameters. 
One of the cool bits about this method is that the size of the vector and matrix values do not matter - as long as you ensure that the decay rates on the matrix are in descening order (longer turnover times last).
This reduced complexity one pool model can be used in place of a first-order linear decay model with any number of pools.

```{r ProxyRate}

#Proxy Decay Rate Calculation
  #Note that the proxy decay rate does not depend on input value changes
Proxy_decayrate.fn <- function(parms){
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive
                             )
                       )
  
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,     -parms$slow_to_fast,   -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5
                              )
  
    ans <- sum(solve(decay_matrix %*% transfer_matrix) %*% allocation_vector)
    
  return(ans)
}  

#Add the proxy decay rate to the main parameter list
Parameters_FivePool.ls$turnoverTime <- Proxy_decayrate.fn(parms = Parameters_FivePool.ls)

#Simulation for a spin-up simulation with the one-pool model
SpinUp_Proxy_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                                    C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))*0.8),
                                    times = FivePoolSimTime,
                                    func = dCdt_OnePool.fn,
                                    parms = Parameters_FivePool.ls) %>%
                          as.data.frame() %>%
                  mutate(RespirationRate = dCdt_OnePool.fn(t = NA, 
                                                            y = c(NA, C_total),
                                                            parms = Parameters_FivePool.ls)[[1]]['Cummulative_Respiration'],
                          .by = everything()
                  )


ggplot(SpinUp_Proxy_sim.df) + 
  geom_line(aes(x=time, y=C_total)) +
  geom_line(data = lsoda(y = c(Cummulative_Respiration=0, 
                                C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                          times = FivePoolSimTime,
                          func = dCdt_OnePool.fn,
                          parms = Parameters_FivePool.ls) %>%
                            as.data.frame() , 
            aes(x=time, y=C_total), linetype="dotted") +
  scale_x_log10()

ggplot(SpinUp_Proxy_sim.df) + 
  geom_line(aes(x=time, y=RespirationRate)) +
  # geom_line(data = lsoda(y = c(Cummulative_Respiration=0, 
  #                               C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
  #                         times = FivePoolSimTime,
  #                         func = dCdt_OnePool.fn,
  #                         parms = Parameters_FivePool.ls) %>%
  #                           as.data.frame() , 
  #           aes(x=time, y=RespirationRate), linetype="dotted") +
  scale_x_log10()

```

# How does it compare?

Does a single pool model structure with first order linear decay actually stand up against a more robust multi-pool structure?
Here we will test it against a five pool Century model in a number of applications and compare the outputs.

## Input types
We can determine how this aggregate decay rate performs by evaluating a varying input rate -  Net Primary Production and the transference of carbon from vegetation to the soil does not stay constat throughout time.
We are simulating four scenarios, using the total carbon input to evaluate how the reduced complexity model responds compared to the five-pool decay model:

+ The *Spin-up* simulation assumes a constant carbon input, while the simulation's intial state (the state variable's values at time $t=0$) is some fraction of steady state.
+ The *Incubation* simulation matches the conditions of incubation studies, where soil and litter are removed from the environment and the new carbon inputs from plant turnover drop to zero. In these experiments, respiration rates (the amount of CO$_2$ put off) are measured from the removed soil and litter.
+ The *Seasonal Variation* simulation uses a sinusoidal input curve to mimic the seasonality of Net Primary Production from vegetation (and thus, to an extent, plant turnover of carbon into the litter and soil pools). 
+ The *Regime Shift* simulation changes the amount of NPP produced in a step function, which shifts the steady state the ecosystem tends to.

Each of these simulations has specific time scales for which we are interested in, as well. 
Spinning up a systems model requires running the simulation for as long as needed to come within a certain tolerance of steady state, so our simulation times here will last longer (this is also dependent on how far from steady state the simulation starts, the One-Pool model only needs around 100 years to spin up from ~80% of steady state, while the Five-Pool CENTURY-style model requires around 3000 years from the same percentage of steady state, and also at various resolutions throughout the simulation to capture data for tunrover times occuring at shorter time scales and at longer ones).
As incubation experiments usually only run for a few years, we will consider a 5-year simulation for incubation, although for reasons we'll see later, we can also run it at a longer time period, for which we can use the Spin-Up time interval.
Seasonality will also only run for five years, as we are primarily curious at how the proxy rate compares over yearly cycles.
Finally, regime shift simulations need only run long enough for the model to capture how long the stocks take to achieve something close to the new steady state value - thus, we will run these simulations over spin-up time interval lengths, and the simulation will start with the initial stocks at the previous regime's steady state, and will remain at the old regime for a year before the new regime kicks in as a step change.


```{r InputTypes}
InputType.fn <- function(parms, 
                         timepoint
                         ) {
  
  
  if(parms$input_type == 'regime shift' & ! all(c('shift_percent', 'shift_time') %in% names(parms))){
          stop('You have a regime shift parameter missing that this function needs.')
          }
  
  if(parms$input_type == 'seasonal'){
      inputs <- (5/300)*sin((pi/6)*timepoint+(3*pi/2))+(5/300) 
          #offset by the parms$input parameter
    }else if(parms$input_type == 'incubation'){
      inputs <- 0
    }else if(parms$input_type == 'regime shift'){
        ifelse(timepoint > parms$shift_time, {
              #print('*')
              inputs <- parms$inputs * parms$shift_percent 
              }, {
                 #print('^')
                 inputs <- parms$inputs
              }
        )
          }else{
            #print('-')
            inputs <- parms$inputs
          }
  
# #More debugging
# print(paste('At time', t, ', the carbon inputs are', inputs))
  
  return(inputs)
}



ShortSimTime <- seq(0,10*12, by=.2) 
#Used for Incubation and Seasonal simulations
  #If you increase resolution to .1, we trigger the conservation of mass stop in the five-pool function for Seasonality

RegimeShiftSimTime <- c(0:12, seq(12.5, 12+(10*12), by=0.5), seq((10*12)+10, (12*1000), by=12))
#Used for the Regime Shift timeline
  #One year for previous regime, higher resolution (dual-weekly) for 10 years after shift, then lower resolution (yearly) 

#FivePoolSimTime <- c(0:(10*12),seq((10*12)+1, 3000*12, by=12))
#Used for the Spinup simulation
#  #Already defined for the earlier runs

# OnePoolSimTime <- 100*12
#   #Already defined for the earlier runs

SimulationInputs.df <- data.frame(time = ShortSimTime, 
                                constant = InputType.fn(parms=list(inputs = Parameters_FivePool.ls$inputs, input_type = 'base'), timepoint = ShortSimTime),
                                incubation = InputType.fn(parms=list(inputs = Parameters_FivePool.ls$inputs, input_type = 'incubation'), timepoint = ShortSimTime),
                                seasonal = InputType.fn(parms=list(inputs = Parameters_FivePool.ls$inputs, input_type = 'seasonal'), timepoint = ShortSimTime)
                                                        )

RegimeInputs <- data.frame(time = RegimeShiftSimTime) %>%
                      mutate('regime shift' = InputType.fn(parms=list(inputs = Parameters_FivePool.ls$inputs, input_type = 'regime shift', shift_percent = 2, shift_time=12), timepoint = time),
                          .by = everything())


ggplot(SimulationInputs.df %>% pivot_longer(cols='constant':'seasonal', names_to = "sim", values_to = "stock")) +
  geom_line(aes(x=time/12, y=stock, color=sim)) +
  facet_wrap(~ sim, nrow=1, scales = "free_x") +
  theme_bw()

Constant_Inputs <- ggplot(SimulationInputs.df) + 
  geom_line(aes(x=time/12, y=constant))

Seasonal_Inputs <- ggplot(SimulationInputs.df) + 
  geom_line(aes(x=time/12, y=seasonal))

Incub_Inputs <- ggplot(SimulationInputs.df) + 
  geom_line(aes(x=time/12, y=incubation))

Regime_Inputs <- ggplot(RegimeInputs %>% rename(stock = 'regime shift') %>% filter(time < 12*5) ) +
  geom_line(aes(x=time/12, y=stock)) # + 
  #scale_x_log10() 

Constant_Inputs + Incub_Inputs + Seasonal_Inputs + Regime_Inputs
```


## Spin up

This is comparing the two simulations we have already coded, so it should be relatively quick.

```{r SpinupCompare}
#Clean up the dataframes produced and create a new one to plot
Spinup_comp_graph.df <- full_join(SpinUp_FivePool_sim.df %>%
                                    select('time', 'RespirationRate', 'C_total') %>%
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'FivePools'),
                             SpinUp_Proxy_sim.df %>% 
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'Proxy')
                             )


SpinUp_Stocks.gr <- ggplot(Spinup_comp_graph.df %>% filter(outcome == 'Total SOC') %>% filter(time < 12*100)) + 
  geom_line(aes(x=time/12, y=stock, color=sim)) 


SpinUp_Resp.gr <- ggplot(Spinup_comp_graph.df %>% filter(outcome == 'Soil Respiration') %>% filter(time < 12*100)) + 
  geom_line(aes(x=time/12, 
                y=stock, 
                #linetype=sim,
                color=sim )) 
  

SpinUp_Stocks.gr + 
    labs(title = "Spin-Up Soil Organic C", x="Time (years)", y="kg-C per m^2") + 
SpinUp_Resp.gr + 
    labs(title = "Spin-Up Respiration Rates", x="Time (years)", y="kg-C per m^2 per month") + 
    plot_layout(guides = "collect", axis_titles = "collect")
```

While the shape of the five pool is very different, this is not a particularly accurate representation of the real world and how it operates, and we also logically assume that our proxy decay rate is at least somewhat reliant on the soil carbon stocks being close to steady state.
What metrics can we use to actually compare this rather than graphs?
We actually can directly compare models as well:

```{r Model2ModelComp}
#difference drive graph for SOC
ggplot(Spinup_comp_graph.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Total SOC')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline(color='red') +
  labs(title="Total SOC Stocks Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")

#difference drive graph for respiration
ggplot(Spinup_comp_graph.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Soil Respiration')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline(color='red') +
  labs(title="Respiration Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")
```
Since our spinup starts relatively far away from steady state, this wasn't a surprise, but we'd like to test this in other situations as well - spinups are, as one might guess from the name - a process used to set up a numerical simulation before experimentation.

## Incubation Studies

How does this aggregate decay rate compare to the full model when soil is removed from its environment, and no new organic carbon enters the system?
(Blurb about incubation studies)


```{r Incubation}
Parameters_FivePool.ls$input_type <- 'incubation'

#simulation for Inbuation
Incub_FivePool_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)),
                      times = ShortSimTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) %>%
                  mutate(RespirationRate = dCdt_FivePool.fn(t = time, 
                                                            y = c(NA, 
                                                                  Lit_metabolic, 
                                                                  Soil_fast, 
                                                                  Lit_structural, 
                                                                  Soil_slow, 
                                                                  Soil_passive),
                                                            parms = Parameters_FivePool.ls
                                                            )[[1]]['Cummulative_Respiration'],
                          .by = everything())


#Using a simple transformation to graph data nicely:
#Incub_FivePool_graph.df <- 


#Graph by pools:
ggplot(Incub_FivePool_sim.df %>%
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                               mutate(pool = factor(pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive")))) +
  geom_line(aes(x=time/12, y=stock)) +
  facet_wrap(~ pool, ncol=1, scales='free') +   
  #scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw()


#Stacked graph
ggplot(Incub_FivePool_sim.df %>%
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                               mutate(pool = factor(pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive"))) ) +
  geom_area(aes(x=time/12, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") #+
  #scale_x_log10() 



#Simulation with the one-pool model
Incub_Proxy_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                                    C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                                    times = ShortSimTime,
                                    func = dCdt_OnePool.fn,
                                    parms = Parameters_FivePool.ls) %>%
                          as.data.frame() %>%
                  mutate(RespirationRate = dCdt_OnePool.fn(t = NA, 
                                                            y = c(NA, C_total),
                                                            parms = Parameters_FivePool.ls
                                                           )[[1]]['Cummulative_Respiration'],
                          .by = everything())

#Graph of the one-pool proxy model
##SOC
ggplot(Incub_Proxy_sim.df) + 
  geom_line(aes(x=time, y=C_total)) +
  geom_hline(yintercept=sum(SS_FivePool.fn(parms=Parameters_FivePool.ls)), linetype="dotted")
  # + #Adds a line for Steady state:
  # geom_line(data = lsoda(y = c(G=0,
  #                               C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
  #                         times = ShortSimTime,
  #                         func = dCdt_OnePool.fn,
  #                         parms = Parameters_FivePool.ls) %>%
  #                           as.data.frame() ,
  #           aes(x=time, y=C_total), linetype="dotted")

##Respiration Rate
ggplot(Incub_Proxy_sim.df) + 
  geom_line(aes(x=time, y=RespirationRate)) 



```
How do these different model structures compare?

```{r IncCompare}
#Clean up the dataframes produced and create a new one to plot
Incubation_sim.df <- full_join(Incub_FivePool_sim.df %>%
                                    select('time', 'RespirationRate', 'C_total') %>%
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'FivePools'),
                             Incub_Proxy_sim.df %>% 
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'Proxy')
                             )


Incub_Stocks.gr <- ggplot(Incubation_sim.df %>% filter(outcome == 'Total SOC') %>% filter(time <= 3*12)) + 
  geom_line(aes(x=time/12, y=stock, color=sim)) 

Incub_Resp.gr <- ggplot(Incubation_sim.df %>% filter(outcome == 'Soil Respiration') %>% filter(time <= 3*12)) + 
  geom_line(aes(x=time/12, y=stock, color=sim)) 
  
Incub_Stocks.gr + 
    labs(title = "Incubation Soil Organic C", x="Time (years)", y="kg-C per m^2") + 
Incub_Resp.gr + 
    labs(title = "Incubation Respiration Rates", x="Time (years)", y="kg-C per m^2 per month") + 
  plot_layout(guides = "collect", axis_titles = "collect")


```


Now let's see the comparison:

```{r IncModel2ModelComp}
#difference drive graph for SOC
ggplot(Incubation_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Total SOC')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Total SOC Stocks Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")

#difference drive graph
ggplot(Incubation_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Soil Respiration')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Respiration Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")
```

## Seasonal Inputs

How does this aggregate decay rate compare to the full model when we consider fluctuating inputs, such as the seasonality of NPP?
(Blurb about why seasonality matters)


```{r Seasonal}
Parameters_FivePool.ls$input_type <- 'seasonal'

#simulation for Seasonal inputs
Season_FivePool_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)),
                      times = ShortSimTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) %>%
                  mutate(RespirationRate = dCdt_FivePool.fn(t = time, 
                                                            y = c(NA, Lit_metabolic, Soil_fast, Lit_structural, Soil_slow, Soil_passive),
                                                            parms = Parameters_FivePool.ls)[[1]]['Cummulative_Respiration'],
                          .by = everything()
                         )


#creates a dataframe to graph both the steady state lines and the spinup
Season_FivePool_graph.df <- full_join(Season_FivePool_sim.df %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Seasonal"), 
                             SS_FivePool_sim.df  %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Steady State")
                             ) %>%
  select(time, pool, stock, sim)

#Setting the Factor allows the pools to show up in the 'right' order
Season_FivePool_graph.df$pool <- factor(Season_FivePool_graph.df$pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive"))


#Graph by pools:
ggplot(Season_FivePool_graph.df) +
  geom_line(aes(x=time, y=stock, linetype=sim)) +
  facet_wrap(~ pool, ncol=1, scales='free') +   
  #scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw() +
  xlim(5*12, 10*12) #Five years

#Stacked graph
ggplot(Season_FivePool_graph.df %>%
        filter(sim == 'Seasonal')) +
  geom_area(aes(x=time, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") 


#Simulation with the one-pool model
Season_Proxy_sim.df <- lsoda(y = c(Cummulative_Respiration=0, 
                                    C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                                    times = ShortSimTime,
                                    func = dCdt_OnePool.fn,
                                    parms = Parameters_FivePool.ls) %>%
                          as.data.frame() %>%
                          mutate(RespirationRate = dCdt_OnePool.fn(t = time, 
                                                                    y = c(NA, C_total),
                                                                    parms = Parameters_FivePool.ls
                                                                   )[[1]]['Cummulative_Respiration'],
                          .by = everything()
                         )


ggplot(Season_Proxy_sim.df) + 
  geom_line(aes(x=time, y=C_total)) +
  geom_line(data = lsoda(y = c(Cummulative_Respiration=0, 
                                C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                          times = ShortSimTime,
                          func = dCdt_OnePool.fn,
                          parms = Parameters_FivePool.ls) %>%
                            as.data.frame() , 
            aes(x=time, y=C_total), linetype="dotted") 

ggplot(Season_Proxy_sim.df) +  
  geom_line(aes(x=time, y=RespirationRate))

```
How does the one-pool proxy decay rate compare?

```{r IncCompare}
#Clean up the dataframes produced and create a new one to plot
Seasonal_sim.df <- full_join(Season_FivePool_sim.df %>%
                                    select('time', 'C_total', 'RespirationRate') %>%
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Total SOC':'Soil Respiration',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'FivePools'),
                             Season_Proxy_sim.df %>% 
                                    rename('Soil Respiration' = 'RespirationRate') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'Proxy')
                             )


ggplot(Seasonal_sim.df %>% filter(outcome == 'Total SOC')) + 
  geom_line(aes(x=time, y=stock, color=sim)) 

ggplot(Seasonal_sim.df %>% filter(outcome == 'Soil Respiration')) + 
  geom_line(aes(x=time, y=stock, color=sim)) 

```


Now let's see the comparison:

```{r IncModel2ModelComp}
#difference drive graph for SOC
ggplot(Seasonal_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Total SOC') #%>%
         #filter(time <= 12)
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Total SOC Stocks Between Models over five years", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")

#difference drive graph
ggplot(Seasonal_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>%
         filter(outcome == 'Soil Respiration') %>%
         filter(time <= 24)
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Respiration Between Models over two years", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")
```

## Regime Shifts

How does this aggregate decay rate compare to the full model when a regime shift occurs and the carbon inputs shift?
(Blurb about Regime shifts)


```{r RegimeShift}

Parameters_FivePool.ls$input_type <- 'regime shift'
Parameters_FivePool.ls$shift_percent <- 2 #doubles the inputs
Parameters_FivePool.ls$shift_time <- 12 #in months; regime shift occurs one year into simulation

##Check that the regime shift time vector matches with the one used for the input graphs
if(RegimeShiftSimTime != c(0:shift_time, seq(shift_time+0.5, shift_time+(10*12), by=0.5), seq((10*12)+10, (12*1000), by=12))){
  print('Your simulation vector does not match the one to create the input graph above.')
}


#simulation for Inbuation
Regime_FivePool_sim.df <- lsoda(y = c(G=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)),
                      times = FivePoolSimTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) 


# #Runs steady states for the new regime as well as the original
# Regime_SSs_sim.df <- full_join(lsoda(y = c(G=0, 
#                                           SS_FivePool.fn(parms = Parameters_FivePool.ls)*Parameters_FivePool.ls$shift_percent),
#                                       times = OnePoolSimTime,
#                                       func = dCdt_FivePool.fn,
#                                       parms = Parameters_FivePool.ls) %>%
#                                   as.data.frame() %>%
#                                   mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) %>%
#                                   pivot_longer(cols = Lit_metabolic:Soil_passive,
#                                       names_to = 'pool',
#                                       values_to = 'stock') %>%
#                                   mutate(sim = "New Regime Steady State") %>%
#                                   select(time, pool, stock, sim), 
#                               SS_FivePool_sim.df  %>% 
#                                   filter(time <= 12*100) %>%
#                                   pivot_longer(cols = Lit_metabolic:Soil_passive,
#                                       names_to = 'pool',
#                                       values_to = 'stock') %>%
#                                   mutate(sim = "Original Regime Steady State") %>%
#                                   select(time, pool, stock, sim)
# )


#creates a dataframe to graph both the steady state lines and the spinup
Regime_FivePool_graph.df <- Regime_FivePool_sim.df %>% 
                                        pivot_longer(cols = Lit_metabolic:Soil_passive,
                                                     names_to = 'pool',
                                                     values_to = 'stock') %>%
                                        mutate(sim = "RegimeShift")


#Setting the Factor allows the pools to show up in the 'right' order
Regime_FivePool_graph.df$pool <- factor(Regime_FivePool_graph.df$pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive"))


#Graph by pools:
ggplot(Regime_FivePool_graph.df %>% filter(sim == "RegimeShift")) +
  geom_line(aes(x=time, y=stock)) + 
  facet_wrap(~ pool, scales='free') +   
  #scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw()

#Stacked graph
ggplot(Regime_FivePool_graph.df %>%
        filter(sim == 'RegimeShift')) +
  geom_area(aes(x=time, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") #+
#  scale_x_log10() 



#Simulation with the one-pool model
Regime_Proxy_sim.df <- lsoda(y = c(G=0, 
                                    C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                                    times = OnePoolSimTime,
                                    func = dCdt_OnePool.fn,
                                    parms = Parameters_FivePool.ls) %>%
                          as.data.frame() 


ggplot(Regime_Proxy_sim.df) + 
  geom_line(aes(x=time, y=C_total)) +
  geom_line(data = lsoda(y = c(G=0, 
                                C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                          times = OnePoolSimTime,
                          func = dCdt_OnePool.fn,
                          parms = Parameters_FivePool.ls) %>%
                            as.data.frame() , 
            aes(x=time, y=C_total), linetype="dotted") #+
  #scale_x_log10()
  #xlim(0,150)

```
How does the one-pool proxy decay rate compare?

```{r RegimeShiftCompare}
#Clean up the dataframes produced and create a new one to plot
RegimeShift_sim.df <- full_join(Regime_FivePool_sim.df %>%
                                    select('time', 'Cummulative_Respiration', 'C_total') %>%
                                    rename('Soil Respiration' = 'Cummulative_Respiration') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'FivePools'),
                             Regime_Proxy_sim.df %>% 
                                    rename('Soil Respiration' = 'Cummulative_Respiration') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'Proxy')
                             )


ggplot(RegimeShift_sim.df %>% 
         filter(outcome == 'Total SOC')
       ) + 
  geom_line(aes(x=time, y=stock, color=sim)) +
  xlim(0,1000)

ggplot(RegimeShift_sim.df %>% 
         filter(outcome == 'Soil Respiration')
       ) + 
  geom_line(aes(x=time, y=stock, color=sim, linetype=sim), alpha = 0.75) #+
#  lim(0,3000) 
  

```


Now let's see the comparison:

```{r RegimeShiftModel2ModelComp}
#difference drive graph for SOC
ggplot(RegimeShift_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Total SOC')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Total SOC Stocks Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")

#difference drive graph
ggplot(RegimeShift_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Soil Respiration')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Respiration Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")
```

## NEWMODEL

(Blurb about NEWMODEL studies)


```{r NEWMODEL, eval=FALSE}
Parameters_FivePool.ls$input_type <- 'new sim'

NEWMODELSimTime <- c(1:10)

#simulation for Inbuation
NEWMODEL_FivePool_sim.df <- lsoda(y = c(G=0, 
                            SS_FivePool.fn(parms = Parameters_FivePool.ls)),
                      times = simTime,
                      func = dCdt_FivePool.fn,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) 


#creates a dataframe to graph both the steady state lines and the spinup
NEWMODEL_FivePool_graph.df <- full_join(NEWMODEL_FivePool_sim.df %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "NEWMODEL"), 
                             SS_FivePool_sim.df  %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Steady State")
                             ) %>%
  select(time, pool, stock, sim)

#Setting the Factor allows the pools to show up in the 'right' order
NEWMODEL_FivePool_graph.df$pool <- factor(NEWMODEL_FivePool_graph.df$pool, levels = c("Lit_metabolic","Lit_structural","Soil_fast","Soil_slow","Soil_passive"))


#Graph by pools:
ggplot(NEWMODEL_FivePool_graph.df) +
  geom_line(aes(x=time, y=stock, linetype=sim)) +
  facet_wrap(~ pool, ncol=1, scales='free') +   
  scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw()

#Stacked graph
ggplot(NEWMODEL_FivePool_graph.df %>%
        filter(sim == 'NEWMODEL')) +
  geom_area(aes(x=time, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") +
  scale_x_log10() 



#Simulation with the one-pool model
NEWMODEL_Proxy_sim.df <- lsoda(y = c(G=0, 
                                    C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                                    times = simTime,
                                    func = dCdt_OnePool.fn,
                                    parms = Parameters_FivePool.ls) %>%
                          as.data.frame() 


ggplot(Proxy_NEWMODEL_sim.df) + 
  geom_line(aes(x=time, y=C_total)) +
  geom_line(data = lsoda(y = c(G=0, 
                                C_total = sum(SS_FivePool.fn(parms=Parameters_FivePool.ls))),
                          times = simTime,
                          func = dCdt_OnePool.fn,
                          parms = Parameters_FivePool.ls) %>%
                            as.data.frame() , 
            aes(x=time, y=C_total), linetype="dotted") +
  #scale_x_log10()
  xlim(0,150)

```
How does the one-pool proxy decay rate compare?

```{r NEWMODELCompare, eval=FALSE}
#Clean up the dataframes produced and create a new one to plot
NEWMODEL_sim.df <- full_join(NEWMODEL_FivePool_sim.df %>%
                                    select('time', 'Cummulative_Respiration', 'C_total') %>%
                                    rename('Soil Respiration' = 'Cummulative_Respiration') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'FivePools'),
                             NEWMODEL_Proxy_sim.df %>% 
                                    rename('Soil Respiration' = 'Cummulative_Respiration') %>%
                                    rename('Total SOC' = 'C_total') %>%
                                    pivot_longer(cols = 'Soil Respiration':'Total SOC',
                                                 values_to = 'stock',
                                                 names_to = 'outcome') %>%
                                    mutate(sim = 'Proxy')
                             )


ggplot(NEWMODEL_sim.df %>% filter(outcome == 'Total SOC')) + 
  geom_line(aes(x=time, y=stock, color=sim)) +
  xlim(0,1000)

ggplot(NEWMODEL_sim.df %>% filter(outcome == 'Soil Respiration')) + 
  geom_line(aes(x=time, y=stock, color=sim, linetype=sim), alpha = 0.75) +
  xlim(0,3000) 
  

```


Now let's see the comparison:

```{r NEWMODELModel2ModelComp, eval=FALSE}
#difference drive graph for SOC
ggplot(NEWMODEL_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Total SOC')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Total SOC Stocks Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")

#difference drive graph
ggplot(NEWMODEL_sim.df %>% 
         pivot_wider(names_from = sim,
                     values_from = stock) %>% 
         filter(outcome == 'Soil Respiration')
       ) +
  geom_point(aes(x=FivePools, y = Proxy)) +
  geom_abline() +
  labs(title="Respiration Between Models", x="One Pool with Proxy Decay Rate", y="Five Pool First-Order Linear Decay")
```



