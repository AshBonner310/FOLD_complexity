---
title: "Litter and soil pools"
author: "Ashley Bonner"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
#useful functions in here

library(tidyverse) #data library
library(deSolve) #ODE solver
library(DiagrammeR) #flow charts
library(patchwork) #cool figure arrangment
library(dplyr) #data wrangling

knitr::opts_chunk$set(echo = TRUE)
```

# A standard one pool model

The rate of change of soil carbon stocks is the balance between the inputs and the outputs because of conservation of mass -- carbon is neither created nor distroyed.
In this simple one pool model we assume a constant input rate ($u$; [mass per area per time]).
The outputs are assumed to be proportional to the stock that is there.
There are other functional forms that could also use but this is the simplest (and also happens to fit incubation experiments).

$\frac{dC}{dt} = u - kC$

where 

  + $C$ is the carbon stock [mass per area]. This is often on the order of 1 to 150 kg-organic-carbon m^-2^ for the first meter of soil (HWSD2)
  + $u$ is the inputs into the soil [mass per area per time]. Between root exodase, root turnover, and surface litter, inputs are difficult to quantify directly. However net primary productivity is often used as a proxy for soil inputs and varies between 0 to 2.5 kg-organic-carbon m^-2^ yr^-1^ with the geographic mode occurring around 0.2 kg-C m^-2^ yr^-1 (MODIS - MOD17A3)
  + $k$ is the decay rate is the fraction of carbon leaving the soil carbon pool per time. This is often framed as it's inverse, turnover time ($k=\frac{1}{\tau}$) which has many interpretation but for this model is the average length of time a carbon atom will spend in the soil. The bulk turnover time in Earth system models is on the order of 10 to 50 years (CMIP5 and CMIP6).
  
From this model we can calculate the steady state value, where the rate of change is zero.
This describes the carbon stock that the system is trending towards as it matures.

$C_{ss} = \frac{u}{k} = u k^{-1} = u\tau$

This also gives us a useful check on our ranges if we assume that soil carbon stocks are generally close to steady state. 
$u\tau = [0, 0.2, 2.5] [10, 15, 50] = [0, 3, 125]$

It's very very close to the stated ranges for the soil carbon stocks of $[1,150] \frac{kg-C}{m^2 yr^1}$.

We can also look at the inputs and carbon stocks to infer the turnover times.
$\frac{C}{u} \left( \frac{kgC/m^2}{kgC/m^2yr }\right)= \frac{[1, 150]}{[0.1, 2.5]} = [0.4, 1500] \left( yr \right)$
which is a MUCH larger range of turnover times.
So this would be consistent with the observations but maybe not constraining of the parameters.

```{r OnePool}
Parameters_OnePool.ls <- list(inputs = 0.2/12, 
                                #u; [0, 2.5] kg-carbon m-2 yr-1; split per month (to fit CENTURY parameters)
                              turnoverTime = 15*12
                                #\tau; [10, 50] yr, by month
                             
                             ) 
simTime <- 100*12

#rate of change function
dCdt_OnePool <- function(t, y, parms, rel_tol = 1e-8){
  ## Debugging code below
  #t <- 0
  #y <- c(G = 0, InitialCarbon_1pool)
  #parms <- parameter.ls
  y <- unname(y)
  CO2 <- y[1] 
  soil <- y[2]
  
  dCO2 <- soil / parms$turnoverTime
  dSoil <- parms$inputs - soil / parms$turnoverTime
  
  #make a relative tolerance to ensure conservation of mass
  if(parms$inputs != 0){ 
    #need this to keep the no-inputs simulation running
    if(abs(parms$inputs - (dCO2 + dSoil))/parms$inputs > rel_tol){ 
      #relative tolerance allowance
        stop('Conservation of mass does not hold')
    }
  }
  return(list(c(G = dCO2, C_total = dSoil)))
}

#steady state function
SS_OnePool <- function(parms){
    ans <- parms$inputs * parms$turnoverTime
  return(c(G = 0, C = ans))
}


ggplot(lsoda(y = SS_OnePool(parms=Parameters_OnePool.ls)*0.7,
                times = seq(0, simTime, by = 1/10),
                func = dCdt_OnePool,
                parms = Parameters_OnePool.ls) %>%
          as.data.frame()
       ) + 
  geom_line(aes(x=time, y=C)) +
  geom_line(data = lsoda(y = SS_OnePool(Parameters_OnePool.ls),
                times = seq(0, simTime, by = 1/10),
                func = dCdt_OnePool,
                parms = Parameters_OnePool.ls) %>%
          as.data.frame(), aes(x=time, y=C), linetype="dotted")


```

Tracking carbon stocks in soil is important to understanding how much carbon could be sequestered, and helps to answer questions around whether soil could serve as a carbon sink or as a source across diverse ecosystems as our climate changes.
Another important metric we will be considering is how much CO$_2$ is respired over a certain period of time.
This largely depends on where the model starts, but discussing the basics here seems pertinent.

# The Century Soil Carbon model - 5 pools

William Parton's Century model was developed in 1988 to describe soil organic matter dynamics and became the base form for SOM modeling in global models today. 

```{r Diagram, echo = FALSE}
grViz("
  digraph Three_Pool_Model {
    rankdir=LR
    
    subgraph outside_the_system{ 
    node[ shape = oval,
          font = Baskerville,
          style=dashed]
    Inputs[label = 'Vegetation']; CarbonDioxide
    }
    
    Inputs  -> Metabolic     [headport=w, color = goldenrod]; 
    Inputs  -> Structural    [headport=w, color = green3]; 
    Fast    -> CarbonDioxide [tailport=s, color = red3]; 
    Slow    -> CarbonDioxide [tailport=s, color=purple3]; 
    Passive -> CarbonDioxide [tailport=s, color=blue3]
    
    Metabolic  -> Fast          [color = goldenrod, tailport = e]
    Metabolic -> CarbonDioxide  [color = goldenrod, tailport = e]
    Structural -> Fast          [color = green3, tailport = e]
    Structural -> Slow          [color = green3, tailport = e]
    Structural -> CarbonDioxide [color = green3, tailport = e]
    
    subgraph Pools{
    
    
      subgraph cluster_LitterPools{
        label = 'Litter Pools'
        
        node[ shape = oval,
              font = Baskerville,
              style = solid]
          rank=same
          
        Metabolic[color=goldenrod, fontcolor=darkgoldenrod]; Structural[color=green3, fontcolor=green4]
              
      }
    
      subgraph cluster_SoilPools {
        label = 'Soil Pools'
    
        node[ shape = oval,
              font = Baskerville,
              style = solid]
        rank = same
          
        Fast[color=red3, fontcolor=red4]; Slow[color=purple3, fontcolor=purple4]; Passive[color=blue3, fontcolor=blue4]
        
        #Fluxes out of Fast
        Fast -> Slow[tailport=s, color = MediumVioletRed]
        Fast -> Passive[tailport=s, color = DarkViolet]
        
        #Fluxes out of Slow
        Fast -> Slow [dir=back, color = MediumVioletRed, headport = s]
        Slow -> Passive[tailport=s, color = SlateBlue3]
        
        #Fluxes out of Passive
        Fast -> Passive[dir=back, color=DarkViolet, headport = s]
        #Slow -> Passive[dir=back, color=SlateBlue3, headport = n]
      }
    }
    }
  }
")

```

```{r Five pool model}

#Calculating Variable Century model parameters
Varying_Century_Parameters.ls <- list(
  SMsplit =  1/8,
    #fraction of plant residue that is structural rather than metabolic
  structural_turnover = 3*12,
    #in months (years times twelve months)
  metabolic_turnover = 0.5*12,
    #in months (years times twelve months)
  lignin_frac = .5,
    #using a placeholder here, still uncertain.
  silt_clay_frac = .4 + .2
    #based on an "ideal" silt and clay fraction
)


Parameters_FivePool.ls <- list(
                    inputs = 0.2/12, #monthly; divided evenly between the months
                      input_to_struc = .125,  
                      input_to_meta = .875,  
                      #no direct inputs into soil pools; C goes through litter pools first
                        input_to_fast = 0,  
                        input_to_slow = 0,  
                        input_to_passive = 0,  
                            
                     #turnover times
                     turnoverTime_meta = .5*12,   #.5y
                     turnoverTime_fast = 1.5*12,    #1.5y
                     turnoverTime_struc = 3*12,    #3y
                     turnoverTime_slow = 25*12,       #25y
                     turnoverTime_passive = 1000*12,  #1000y
                     
                       struc_to_fast = Varying_Century_Parameters.ls$lignin_frac*.5, 
                          #lignin fraction determines split between slow and fast, then 50% respired
                       struc_to_slow = Varying_Century_Parameters.ls$lignin_frac*.7, 
                          #lignin fraction determines split between slow and fast, then 30% respired
                       meta_to_fast = .45,    #55% as CO2
                       fast_to_slow = 1-(0.85-(0.68*Varying_Century_Parameters.ls$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                      #all the zero-flows to/from litter pools:
                        meta_to_struc = 0,
                        meta_to_slow = 0,
                        meta_to_passive = 0,
                        struc_to_meta = 0,
                        struc_to_passive = 0,
                        fast_to_meta = 0,
                        slow_to_meta = 0,
                        passive_to_meta = 0,
                        fast_to_struc = 0,
                        slow_to_struc = 0,
                        passive_to_struc = 0,
                        
                    #all other soil flows
                       fast_to_slow = 1-(0.85-(0.68*Varying_Century_Parameters.ls$silt_clay_frac))-.004,       
                          #respiration determined in CENTURY based on the total percentage of silt and clay in the soil.
                       fast_to_passive = 0.004,    
                       slow_to_fast = 0.42,        
                       slow_to_passive = 0.03,     
                       passive_to_fast = 0.45,     
                       passive_to_slow = 0         # CENTURY does not include this flow
                       )

#steady state calculations for each pool
SS_FivePool.fns <- function(parms){
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5)
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive))
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,    -parms$slow_to_fast,    -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  ans <- solve(decay_matrix  %*% transfer_matrix ,parms$inputs * allocation_vector)

  return(c(Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]))
}


#ODE for a five-pool FOLD model
dCdt_FivePool.fns <- function(t, y, parms){
  G <- y[1]
  pools <- matrix(y[2:6], nrow=5)
  allocation_vector <- matrix(c(parms$input_to_meta, 
                                parms$input_to_fast, 
                                parms$input_to_struc, 
                                parms$input_to_slow, 
                                parms$input_to_passive),
                              nrow = 5
                              )
  
  decay_matrix <- diag(x= 1/c(parms$turnoverTime_meta,
                             parms$turnoverTime_fast,
                             parms$turnoverTime_struc,
                             parms$turnoverTime_slow,
                             parms$turnoverTime_passive
                             )
                       )
  
  transfer_matrix <- matrix(c(
    1,                      -parms$fast_to_meta,    -parms$struc_to_meta,    -parms$slow_to_meta,    -parms$passive_to_meta,
    -parms$meta_to_fast,    1,                      -parms$struc_to_fast,     -parms$slow_to_fast,   -parms$passive_to_fast,
    -parms$meta_to_struc,   -parms$fast_to_struc,   1,                       -parms$slow_to_struc,   -parms$passive_to_struc,
    -parms$meta_to_slow,    -parms$fast_to_slow,    -parms$struc_to_slow,    1,                      -parms$passive_to_slow,
    -parms$meta_to_passive, -parms$fast_to_passive, -parms$struc_to_passive, -parms$slow_to_passive,  1
    ),
                            nrow = 5,
                            byrow=TRUE)
  
  ans <- parms$inputs * allocation_vector - decay_matrix %*% transfer_matrix %*% pools
  
  resp <- decay_matrix %*% transfer_matrix %*% pools
  total_resp <- sum(resp)
  
  return(list(c(
           G = total_resp,
           Lit_metabolic = ans[1],
           Soil_fast = ans[2],
           Lit_structural = ans[3],
           Soil_slow = ans[4],
           Soil_passive = ans[5]
           )
           )
         )
}


#making a more realistic simulation time for a monthly model with turnover times in the 1000s
simTime <- c(0:1500,seq(1500+1, 10000*4, by=100))

#simulation at partial steady state
FivePool_Spinup_sim.df <- lsoda(y = c(G=0, 
                            SS_FivePool.fns(parms = Parameters_FivePool.ls)*0.5),
                      times = simTime,
                      func = dCdt_FivePool.fns,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) 


#simulation at steady state
FivePool_SS_sim.df <- lsoda(y = c(G=0, 
                            SS_FivePool.fns(parms = Parameters_FivePool.ls)),
                      times = simTime,
                      func = dCdt_FivePool.fns,
                      parms = Parameters_FivePool.ls) %>%
                  as.data.frame() %>%
                  mutate(C_total = Lit_metabolic + Lit_structural + Soil_fast + Soil_slow + Soil_passive) # %>%.  
                  #rename_with(.fn = ~paste0(.x, '_SS'), 
                  #            .cols = Lit_metabolic:C_total).   ##Went with a different method for graphing, created a simulation marker column instead of changin the column names

#creates a dataframe to graph both the steady state lines and the spinup
FivePool_sim.df <- full_join(FivePool_Spinup_sim.df %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Spinup"), 
                             FivePool_SS_sim.df  %>% 
                               pivot_longer(cols = Lit_metabolic:Soil_passive,
                                  names_to = 'pool',
                                  values_to = 'stock') %>%
                                  mutate(sim = "Steady State")
                             ) %>%
  select(time, pool, stock, sim)



#Graph by pools:
ggplot(FivePool_sim.df) +
  geom_line(aes(x=time, y=stock, linetype=sim)) +
  facet_wrap(~ pool, ncol=1)+ #scales='free') +   
  scale_x_log10() +  #Comment this line to get time -not- scaled by a log value
  theme_bw()

FivePool_sim.df %>%
        filter(sim == 'Spinup') %>% #removes the Steady state simulation values
         select(!sim) #removes the sim column (just because I want to)
FivePool_sim.df$pool <- factor()

#Stacked graph
ggplot(FivePool_sim.df %>%
        #pivot_wider(names_from = pool, values_from = stock) %>%
        filter(sim == 'Spinup') %>% #removes the Steady state simulation values
         select(!sim) #removes the sim column (just because I want to)
        ) +
  geom_area(aes(x=time, y=stock, fill = pool)) +
  scale_fill_brewer(palette = "Spectral") +
  scale_x_log10() 
```